Sensitivity to mispronunciations
=======================================================================

```{r, include = FALSE}
knitr::read_chunk("./helpers.R")
if (interactive()) source("./helpers.R")
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r helpers, message = FALSE, warning = FALSE}
```

```{r, include = FALSE}
# knitr::opts_chunk$set(cache = TRUE)
constants$cap_emp_and_sim <- 
  "Points: Emprical means ± SE.
Ribbons: Mean ± 95% CI for 1000 simulated children."
library(bayesplot)
theme_set(theme_teej())
```

```{r}
d_raw <- readr::read_csv("./data/aim2-model-ready.csv.gz") %>% 
  select(-starts_with("ot"))
  # filter(!is.na(Bias_Fam)) %>% 
  # filter(0 <= Time) %>% 
# %>% 
#   polypoly::poly_add_columns(
#     Time, degree = 3, scale_width = 1, prefix = "ot")

# Flip things so that the nonword and real-word curves go upward
d_raw_mp <- d_raw %>% 
  filter(Condition == "MP") 

d_raw_all <- d_raw %>% 
  filter(Condition == "MP") %>% 
  group_by(Study, ResearchID, Time) %>% 
  summarise(
    Bias_Fam = "all",
    Distractor = sum(Distractor),
    Target = sum(Target),
    Looks = sum(Looks),
    Elsewhere = sum(Elsewhere),
    Missing = sum(Missing), 
    Primary = sum(Primary),
    Trials = Primary + Distractor,
    Prop = Primary / Trials,
    PropSE = se_prop(Prop, Trials),
    PropNA = Missing / Looks
  )

d_raw_mp %>% 
  bind_rows(d_raw_all) %>%
  ggplot() + 
    aes(x = Time, y = Prop, color = Study) + 
    stat_summary() + 
    facet_grid(~ Bias_Fam)

d <- d_raw %>% 
  select(-starts_with("ot")) %>% 
  filter(Condition == "MP", !is.na(Bias_Fam), 300 <= Time) %>% 
  mutate(Trials = Target + Distractor) %>% 
  polypoly::poly_add_columns(
    Time, degree = 3, scale_width = 1, prefix = "ot")

# d %>% 
#   tjmisc::sample_n_of(20, ResearchID) %>% 
#   ggplot() + 
#     aes(x = Time, y = Prop) + 
#     geom_line(aes(group = interaction(ResearchID))) +
#     facet_grid(Study ~ Bias_Fam) + 
#     stat_summary() + 
#   labs(
#     title = "Results for 20 random children")

study_child_with_empty_cells <- d %>% 
  filter(Trials < 4) %>% 
  distinct(Study, ResearchID, Bias_Fam)

study_counts <- study_child_with_empty_cells %>%
  count(Study, Bias_Fam) %>% 
  tidyr::complete(Bias_Fam, Study, fill = list(n = 0))

study_counts_f <- study_counts %>%
  filter(Bias_Fam == "Familiar") %>% 
  split(.$Study) %>%
  lapply(pull, n) %>%
  set_names(stringr::str_replace, "TimePoint", "T")

study_counts_u <- study_counts %>%
  filter(Bias_Fam == "Unfamiliar") %>% 
  split(.$Study) %>%
  lapply(pull, n) %>%
  set_names(stringr::str_replace, "TimePoint", "T")

d <- d %>% 
  anti_join(study_child_with_empty_cells)

d_u <- d %>% filter(Bias_Fam == "Unfamiliar")
d_f <- d %>% filter(Bias_Fam == "Familiar")


library(brms)
mp_unfam <- readr::read_rds("data/aim2-mp-unfam2.rds.gz")
mp_unfam

mp_fam <- readr::read_rds("data/aim2-mp-fam.rds.gz")
mp_fam


```

For the mispronunciation trials, there is no correct "target", as there
is in the nonword trials and real word trials. I separated the
mispronunciation trials based on initial fixation location. One model
handled trials a child's gaze started on the familiar object and another
model handled trials starting on the unfamiliar object. For these
models, I fit a growth curve model that included indicators for Age and
interations Time × Age interactions, like the one from chapter XX. The
basic model was therefore:

`r insert_html_math()`
\small
\begin{align*}
   \text{log-odds}(\mathit{looking\,}) =\
    &\beta_0 + 
      \beta_1\text{Time}^1 + 
      \beta_2\text{Time}^2 + 
      \beta_3\text{Time}^3\ + 
      &\text{[age 3 growth curve]} \\
    (&\gamma_{0} + 
      \gamma_{1}\text{Time}^1 + 
      \gamma_{2}\text{Time}^2 +
      \gamma_{3}\text{Time}^3)*\text{Age4}\ + \
      &\text{[adjustments for age 4]} \\
    (&\delta_{0} + 
      \delta_{1}\text{Time}^1 + 
      \delta_{2}\text{Time}^2 +
      \delta_{3}\text{Time}^3)*\text{Age5} \
      &\text{[adjustments for age 5]} \\
\end{align*}
`r insert_html_math()`

[Appendix \@ref(aim2-gca-models)](#aim2-gca-models) contains the R code
used to fit these models along with a description of the specifications
represented by the model syntax. The mixed model included by-child and
by-child-by-age random effects so that it captured how some of a child's
growth curve features may be similar over developmental time
and may differ at each age.

For these analyses, I modeled the data from `r min(d$Time)`
to `r max(d$Time)` ms after target onset. As in the real-word vs.
nonword analyses, I removed any Age × Child levels if a child had fewer
than 4 fixations in a single time bin. In other words, children had to
have at least 4 looks to one of the images in every 50 ms time bin. For
the familiar-initial trials, this screening removed
`r study_counts_f$T1` children from age 3, `r study_counts_f$T2` from
age 4, and `r study_counts_f$T3` from age 5, and for the
unfamiliar-initial trials, this screening removed `r study_counts_u$T1`,
`r study_counts_u$T2`, and `r study_counts_u$T3` children from age 3,
age 4, and age 5, respectively.

## Unfamiliar-initial trials



```{r unfam-initial-mp-trias, fig.width=6, fig.height=4, out.width="80%"}
# fits <- augment_linpred(mp_unfam, d_u, nsamples = 100)
# 
# fits %>% 
#   sample_n_of(4, ResearchID) %>% 
#   ggplot() + 
#   aes(x = Time, y = Prop, color = Study) + 
#   geom_line() + 
#   geom_line(
#     aes(
#       group = interaction(Study, .draw, ResearchID),
#       y = plogis(.posterior_value)),
#     alpha = .05) + 
#   facet_wrap("ResearchID") 

# # Population averages vs average of lines in sample
# fits2 <- augment_linpred(mp_unfam, d_u, re_formula = NA, nsamples = 100)
# fits2 %>% 
#   ggplot() + 
#   aes(x = Time, y = Prop, color = Study) + 
#   stat_summary() +
#   geom_line(
#     aes(
#       group = interaction(Study, .draw),
#       y = plogis(.posterior_value)),
#     data = . %>% filter(ResearchID == "036L"),
#     alpha = .05) + 
#   labs(
#     caption = "fixed-effect predictions")
# 

# # Average of posterior fits of lines in sample vs average of lines in sample
# fits %>% 
#   ggplot() + 
#   aes(x = Time, y = Prop, color = Study) + 
#   stat_summary() +
#   stat_summary(
#     aes(group = interaction(Study, .draw), y = plogis(.posterior_value)),
#     geom = "line",
#     fun.y = "mean",
#     alpha = .05) + 
#   labs(
#     caption = "averages of posterior fits")

newdata <- d_u %>% 
  distinct(Time, ot1, ot2, ot3, Study) %>% 
  mutate(ResearchID = "zzz", Target = 0, Trials = 30)

m_u_new_fits <- augment_linpred(
  mp_unfam, newdata, nsamples = 1000, allow_new_levels = TRUE) %>% 
  mutate(Study = convert_study_to_age(Study)) 

df_u_label <- tibble::tribble(
  ~Study, ~Time, ~Prop,
  "Age 3", 1050, .42,
  # "Age 4", 1000, .42,
  "Age 5", 1300, .73)

d_u_plotting <- d_u %>% 
  mutate(Study = convert_study_to_age(Study)) 


ggplot(d_u_plotting) + 
  aes(x = Time, y = Prop, color = Study) + 
  geom_hline(yintercept = .5, size = 2, color = "white") +
  stat_summary(fun.data = mean_se, geom = "pointrange") + 
  stat_summary(
    aes(group = Study, fill = Study, y = plogis(.posterior_value)),
    data = m_u_new_fits,
    fun.data = mean_cl_normal,
    geom = "ribbon",
    alpha = .3,
    color = NA) + 
  stat_summary(
    aes(group = Study, y = plogis(.posterior_value)),
    data = m_u_new_fits,
    fun.y = mean,
    geom = "line") + 
  geom_text(
    aes(label = Study),
    data = df_u_label,
    size = 5, 
    family = "Lato Semibold") +
  geom_text(
    aes(label = label),
    data = data_frame(
      Time = 425, 
      Prop = .11, 
      label = constants$note_mp_unfam),
    size = 3, 
    hjust = 0,
    color = constants$col_off_black,
    family = "Lato") +
  scale_fill_study() + 
  scale_color_study() + 
  expand_limits(y = .76) +
  guides(color = FALSE, fill = FALSE) +
  theme(plot.caption = element_text(lineheight = 1.2)) +
  labs(
    x = constants$x_time,
    y = constants$y_prop_fam,
    caption = constants$cap_emp_and_sim)

test <- posterior_samples(mp_unfam, pars = "^b_") %>% 
  mutate(
    b_Intercept_Age3 = b_Intercept,
    b_Intercept_Age4 = b_Intercept + b_StudyTimePoint2,
    b_Intercept_Age5 = b_Intercept + b_StudyTimePoint3,
    b_ot1_Age3 = b_ot1,
    b_ot1_Age4 = b_ot1 + `b_ot1:StudyTimePoint2`,
    b_ot1_Age5 = b_ot1 + `b_ot1:StudyTimePoint3`,
    b_ot2_Age3 = b_ot2,
    b_ot2_Age4 = b_ot2 + `b_ot2:StudyTimePoint2`,
    b_ot2_Age5 = b_ot2 + `b_ot2:StudyTimePoint3`,
    b_ot3_Age3 = b_ot3,
    b_ot3_Age4 = b_ot3 + `b_ot3:StudyTimePoint2`,
    b_ot3_Age5 = b_ot3 + `b_ot3:StudyTimePoint3`,
    d_Intercept_Age4 = b_Intercept_Age4 - b_Intercept_Age3,
    d_Intercept_Age5 = b_Intercept_Age5 - b_Intercept_Age4,
    d_ot1_Age4 = b_ot1_Age4 - b_ot1_Age3,
    d_ot1_Age5 = b_ot1_Age5 - b_ot1_Age4,
    d_ot2_Age4 = b_ot2_Age4 - b_ot2_Age3,
    d_ot2_Age5 = b_ot2_Age5 - b_ot2_Age4,
    d_ot3_Age4 = b_ot3_Age4 - b_ot3_Age3,
    d_ot3_Age5 = b_ot3_Age5 - b_ot3_Age4)

mcmc_intervals(test, regex_pars = "Age")
```

When children start on the image of a novel object and hear a
mispronunciation, they tend to look to the familiar image. Figure XX shows the average of children's growth curves along with the model's average of 1000 simulated children. The growth
curves all cross the .5 threshold, so that the children on average look
more the familiar image than the unfamilar image. Granted, this
tendency is not as great as that observed for the nonwords or real
words. For those conditions, the average growth curves reached a peak of
around .77 at age 3 whereas for the mispronunciations the peak is around
.62. Thus, children show much greater uncertainty compared to the other
two conditions. Similarly, for the real word condition, the average
age 3 growth curve crosses the .5 looking probability around 775 ms
after target onset whereas in the mispronunciation condition, this
threshold is crossed at 1000 ms.

One can readily appreciate that children more quickly and more reliably
look to the familiar image at age 5, while the differences between age 3
and age 4 are less clear cut.

```{r}
mp_unfam
```












```{r, eval = FALSE}


constants









mcmc_intervals(as.matrix(mp_unfam), regex_pars = "b_")
zoo::rollmedian(x, 5, fill = NA)
length(zoo::rollmedian(x, 5))


try2 <- fits %>% 
  tjmisc::sample_n_of(10, .draw) %>% 
  group_by(.draw, Study, ResearchID) %>% 
  mutate(
    med = zoo::rollmedian(.posterior_value, 5, fill = "extend")
  )

```


```{r}

# fits <- augment_linpred(mp_fam, d_f, nsamples = 100)
# 
# fits %>% 
#   sample_n_of(4, ResearchID) %>%
#   # filter(ResearchID == "644L") %>% 
#   ggplot() + 
#   aes(x = Time, y = Prop, color = Study) + 
#   geom_pointrange(aes(ymin = Prop - PropSE, ymax = Prop + PropSE)) + 
#   geom_line(
#     aes(
#       group = interaction(Study, .draw, ResearchID),
#       y = plogis(.posterior_value)),
#     alpha = .05) + 
#   facet_wrap("ResearchID") 
# 
# # Population averages vs average of lines in sample
# fits2 <- augment_linpred(mp_fam, d_f, re_formula = NA, nsamples = 100)
# fits2 %>% 
#   ggplot() + 
#   aes(x = Time, y = Prop, color = Study) + 
#   stat_summary() +
#   geom_line(
#     aes(
#       group = interaction(Study, .draw),
#       y = plogis(.posterior_value)),
#     data = . %>% filter(ResearchID == "036L"),
#     alpha = .05) + 
#   labs(
#     caption = "fixed-effect predictions")
# 
# 
# # Average of posterior fits of lines in sample vs average of lines in sample
# fits %>% 
#   ggplot() + 
#   aes(x = Time, y = Prop, color = Study) + 
#   stat_summary() +
#   stat_summary(
#     aes(group = interaction(Study, .draw), y = plogis(.posterior_value)),
#     geom = "line",
#     fun.y = "mean",
#     alpha = .05) + 
#   labs(
#     caption = "averages of posterior fits")

f_newdata <- d_f %>% 
  distinct(Time, ot1, ot2, ot3, Study) %>% 
  mutate(ResearchID = "zzz", Target = 0, Trials = 30)

m_f_new_fits <- augment_linpred(
  mp_fam, f_newdata, nsamples = 1000, allow_new_levels = TRUE) %>% 
  mutate(Study = convert_study_to_age(Study))

df_f_label <- tibble::tribble(
  ~Study, ~Time, ~Prop,
  "Age 3", 650, .80,
  "Age 4", 1000, .41,
  "Age 5", 1400, .66)

df_f_plotting <- d_f %>% 
  mutate(Study = convert_study_to_age(Study)) 

ggplot(df_f_plotting) + 
  aes(x = Time, y = Prop, color = Study) + 
  geom_hline(yintercept = .5, size = 2, color = "white") +
  stat_summary(fun.data = mean_se, geom = "pointrange") + 
  stat_summary(
    aes(group = Study, fill = Study, y = plogis(.posterior_value)),
    data = m_f_new_fits,
    fun.data = mean_cl_normal,
    geom = "ribbon",
    alpha = .3,
    color = NA) + 
  stat_summary(
    aes(group = Study, y = plogis(.posterior_value)),
    data = m_f_new_fits,
    fun.y = mean,
    geom = "line") + 
  geom_text(
    aes(label = Study),
    data = df_f_label,
    size = 5, 
    family = "Lato Semibold") +
  geom_text(
    aes(label = label),
    data = data_frame(
      Time = 410, 
      Prop = .93, 
      label = constants$note_mp_fam),
    size = 3, 
    hjust = 0,
    color = constants$col_off_black,
    family = "Lato") +
  scale_fill_study() + 
  scale_color_study() + 
  expand_limits(y = .38) +
  guides(color = FALSE, fill = FALSE) +
  theme(plot.caption = element_text(lineheight = 1.2)) +
  labs(
    x = constants$x_time,
    y = constants$y_prop_fam,
    caption = constants$cap_emp_and_sim)






```



```{r lmers, eval = FALSE}
d_u_1 <- d %>% filter(Bias_Fam == "Unfamiliar", Study == "TimePoint1")
m_u_1 <- glmer(
  cbind(Target, Distractor) ~ 
    (ot1 + ot2 + ot3) + 
    (ot1 + ot2 + ot3 | ResearchID),
  family = binomial,
  data = d_u_1
) 
d_u_1 <- d %>% filter(Bias_Fam == "Unfamiliar", Study == "TimePoint1")
m_u_1 <- glmer(
  cbind(Target, Distractor) ~ 
    (ot1 + ot2 + ot3) + 
    (ot1 + ot2 + ot3 | ResearchID),
  family = binomial,
  data = d_u_1
) 

a_u_1 <- broom::augment(m_u_1) %>% 
  select(-1) %>% 
  left_join(d_u_1)

ggplot(a_u_1) + 
  aes(x = Time, y = Prop) + 
  geom_line(
    aes(group = ResearchID), 
    position = position_jitter(height = .01), 
    alpha = .4) + 
  stat_summary(aes(color = "empirical")) + 
  stat_summary(aes(y = plogis(.fixed), color = "fixef")) + 
  stat_summary(aes(y = plogis(.fitted), color = "fitted"))


peak <- a_u_1 %>% 
  group_by(Study, ResearchID) %>% 
  top_n(5, plogis(.fitted)) %>% 
  summarise(
    peak = median(plogis(.fitted))
  )


ggplot(a_u_1) + 
  aes(x = Time, y =  plogis(.fitted)) + 
  geom_line(
    aes(group = ResearchID), 
    # position = position_jitter(height = .01), 
    alpha = .4) 


d_f_1 <- d %>% filter(Bias_Fam == "Familiar", Study == "TimePoint1")
m_f_1 <- glmer(
  cbind(Target, Distractor) ~ 
    (ot1 + ot2 + ot3) + 
    (ot1 + ot2 + ot3 | ResearchID),
  family = binomial,
  data = d_f_1
) 
summary(m_f_1)


a_f_1 <- broom::augment(m_f_1) %>% 
  select(-1) %>% 
  left_join(d_f_1)

ggplot(a_f_1) + 
  aes(x = Time, y =  plogis(.fitted)) + 
  geom_line(
    aes(group = ResearchID), 
    # position = position_jitter(height = .01), 
    alpha = .4) 

ggplot(a_f_1) + 
  aes(x = Time, y = Prop) + 
  geom_line(
    aes(group = ResearchID), 
    position = position_jitter(height = .01), 
    alpha = .4) + 
  stat_summary(aes(color = "empirical")) + 
  stat_summary(aes(y = plogis(.fixed), color = "fixef")) + 
  stat_summary(aes(y = plogis(.fitted), color = "fitted"))




```


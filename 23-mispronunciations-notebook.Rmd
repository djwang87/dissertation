Sensitivity to mispronunciations
=======================================================================

```{r setup, include = FALSE}
knitr::read_chunk("./helpers.R")
if (interactive()) source("./helpers.R")
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r helpers, message = FALSE, warning = FALSE}
```

```{r plotting-helpers, include = FALSE}
# knitr::opts_chunk$set(cache = TRUE)
constants$cap_emp_and_sim <- 
  "Points: Emprical means ± SE.
Ribbons: Mean ± 95% CI for 1000 simulated children."
constants$cap_emp_and_draw <- 
  "Intervals: Empirical mean ± SE. Lines: 100 posterior means."

library(bayesplot)
theme_set(theme_teej())
```

```{r load, include = FALSE}
d_raw <- readr::read_csv("./data/aim2-model-ready.csv.gz")

d <- d_raw %>% 
  select(-starts_with("ot")) %>% 
  filter(Condition == "MP", !is.na(Bias_Fam), 300 <= Time) %>% 
  mutate(Trials = Target + Distractor) %>% 
  polypoly::poly_add_columns(
    Time, degree = 3, scale_width = 1, prefix = "ot")

study_child_with_empty_cells <- d %>% 
  filter(Trials < 4) %>% 
  distinct(Study, ResearchID, Bias_Fam)

study_counts <- study_child_with_empty_cells %>%
  count(Study, Bias_Fam) %>% 
  tidyr::complete(Bias_Fam, Study, fill = list(n = 0))

study_counts_f <- study_counts %>%
  filter(Bias_Fam == "Familiar") %>% 
  split(.$Study) %>%
  lapply(pull, n) %>%
  set_names(stringr::str_replace, "TimePoint", "T")

noun_f_t1 <- ngettext(study_counts_f$T1, "child", "children")

study_counts_u <- study_counts %>%
  filter(Bias_Fam == "Unfamiliar") %>% 
  split(.$Study) %>%
  lapply(pull, n) %>%
  set_names(stringr::str_replace, "TimePoint", "T")

d <- d %>% 
  anti_join(study_child_with_empty_cells)

d_u <- d %>% filter(Bias_Fam == "Unfamiliar")
d_f <- d %>% filter(Bias_Fam == "Familiar")

readr::write_csv(d_u, "./data/aim2-mp-unfam-modeled-data.csv.gz")
readr::write_csv(d_f, "./data/aim2-mp-fam-modeled-data.csv.gz")

library(brms)
mp_unfam <- readr::read_rds("./data/aim2-mp-unfam.rds.gz")
mp_unfam

mp_fam <- readr::read_rds("data/aim2-mp-fam.rds.gz")
mp_fam

unfam_peaks <- readr::read_csv("./data/aim2-mp-unfam-peaks.csv.gz")
fam_peaks <- readr::read_csv("./data/aim2-mp-fam-peaks.csv.gz")

```

For the mispronunciation trials, there is no correct "target", as there
is for the nonword or real word trials. The design of the task allows
the child to associate the mispronunciation with a unfamilar object or
with a familiar object with phonologicallly similar name. As a result,
there are not any "distractor-initial" trials. Therefore, I analyzed the
mispronunciation trials separately for both initial fixation locations.
One model handled trials a child's gaze started on the familiar object
and another model handled trials starting on the unfamiliar object. For
these models, I fit a growth curve model that included indicators for
Age and interations Time × Age interactions, like the one from
[Chapter \@ref(fam-rec)](#fam-rec). The basic model was therefore:

$$
\small
\begin{align*}
   \text{log-odds}(\mathit{looking\,}) =\
    &\beta_0 + 
      \beta_1\text{Time}^1 + 
      \beta_2\text{Time}^2 + 
      \beta_3\text{Time}^3\ + 
      &\text{[age 3 growth curve]} \\
    (&\gamma_{0} + 
      \gamma_{1}\text{Time}^1 + 
      \gamma_{2}\text{Time}^2 +
      \gamma_{3}\text{Time}^3)*\text{Age}\,\text{4} + \
      &\text{[adjustments for age 4]} \\
    (&\delta_{0}\!\ + 
      \delta_{1}\text{Time}^1\!\ + 
      \delta_{2}\text{Time}^2\!\ +
      \delta_{3}\text{Time}^3)*\text{Age}\,\text{5} \
      &\text{[adjustments for age 5]} \\
\end{align*}
$$

[Appendix \@ref(aim2-gca-models)](#aim2-gca-models) contains the R code
used to fit these models along with a description of the specifications
represented by the model syntax. The mixed model included by-child and
by-child-by-age random effects so that it captured how some of a child's
growth curve features may be similar over developmental time
and may differ at each age.

For these analyses, I modeled the data from `r min(d$Time)`
to `r max(d$Time)` ms after target onset. As in the real-word vs.
nonword analyses, I removed any Age × Child levels if a child had fewer
than 4 fixations in a single time bin. Children had to have at least 4
looks to one of the two images in every 50 ms time bin. For the
familiar-initial trials, this screening removed `r study_counts_f$T1`
`r noun_f_t1` at age 3, `r study_counts_f$T2` at age 4, and
`r study_counts_f$T3` tage 5, and for the unfamiliar-initial trials,
this screening removed `r study_counts_u$T1`, `r study_counts_u$T2`, and
`r study_counts_u$T3` children at ages 3, 4, and 5, respectively.


## Unfamiliar-initial trials





```{r unfam-model}
test <- posterior_samples(mp_unfam, pars = "^b_") %>% 
  mutate(
    b_Intercept_Age3 = b_Intercept,
    b_Intercept_Age4 = b_Intercept + b_StudyTimePoint2,
    b_Intercept_Age5 = b_Intercept + b_StudyTimePoint3,
    b_ot1_Age3 = b_ot1,
    b_ot1_Age4 = b_ot1 + `b_ot1:StudyTimePoint2`,
    b_ot1_Age5 = b_ot1 + `b_ot1:StudyTimePoint3`,
    b_ot2_Age3 = b_ot2,
    b_ot2_Age4 = b_ot2 + `b_ot2:StudyTimePoint2`,
    b_ot2_Age5 = b_ot2 + `b_ot2:StudyTimePoint3`,
    b_ot3_Age3 = b_ot3,
    b_ot3_Age4 = b_ot3 + `b_ot3:StudyTimePoint2`,
    b_ot3_Age5 = b_ot3 + `b_ot3:StudyTimePoint3`,
    b_Intercept_Prop_Age3 = plogis(b_Intercept_Age3),
    b_Intercept_Prop_Age4 = plogis(b_Intercept_Age4),
    b_Intercept_Prop_Age5 = plogis(b_Intercept_Age5),
    d_Intercept_Age4 = b_Intercept_Age4 - b_Intercept_Age3,
    d_Intercept_Age5 = b_Intercept_Age5 - b_Intercept_Age4,
    d_Intercept_Prop_Age4 = b_Intercept_Prop_Age4 - b_Intercept_Prop_Age3,
    d_Intercept_Prop_Age5 = b_Intercept_Prop_Age5 - b_Intercept_Prop_Age4,
    d_Intercept_Prop_Age5_3 = b_Intercept_Prop_Age5 - b_Intercept_Prop_Age3,
    d_ot1_Age4 = b_ot1_Age4 - b_ot1_Age3,
    d_ot1_Age5 = b_ot1_Age5 - b_ot1_Age4,
    d_ot2_Age4 = b_ot2_Age4 - b_ot2_Age3,
    d_ot2_Age5 = b_ot2_Age5 - b_ot2_Age4,
    d_ot3_Age4 = b_ot3_Age4 - b_ot3_Age3,
    d_ot3_Age5 = b_ot3_Age5 - b_ot3_Age4)

unfam_peaks <- readr::read_csv("./data/aim2-mp-unfam-peaks.csv.gz")

group_average_peaks <- unfam_peaks %>%
  mutate(
    Study = convert_study_to_age(Study),
    Peak = plogis(med)) %>%
  group_by(Study, .draw) %>%
  summarise_at(vars(Peak), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  tidyr::spread(Study, Peak) %>% 
  select(-.draw) %>% 
  mutate(d_43 = `Age 4` - `Age 3`, d_54 = `Age 5` - `Age 4`) %>% 
  mcmc_intervals_data()

group_peaks <- group_average_peaks %>% 
  split(.$parameter) %>% 
  lapply(pull, m) %>% 
  lapply(printy::fmt_fix_digits, 2) %>% 
  lapply(printy::fmt_leading_zero)

i_ints <- mcmc_intervals_data(test, regex_pars = "Prop_Age") %>% 
  split(.$parameter) %>% 
  fmt_inline_median_interval() %>% 
  add_ui_slug_to_first("90% UI: ") %>% 
  lapply(stringr::str_replace_all, "0[.]", ".")

```


```{r explore-intervals2, eval = FALSE}
test <- posterior_samples(mp_unfam, pars = "^b_") %>% 
  mutate(
    b_Intercept_Age3 = b_Intercept,
    b_Intercept_Age4 = b_Intercept + b_StudyTimePoint2,
    b_Intercept_Age5 = b_Intercept + b_StudyTimePoint3,
    b_ot1_Age3 = b_ot1,
    b_ot1_Age4 = b_ot1 + `b_ot1:StudyTimePoint2`,
    b_ot1_Age5 = b_ot1 + `b_ot1:StudyTimePoint3`,
    b_ot2_Age3 = b_ot2,
    b_ot2_Age4 = b_ot2 + `b_ot2:StudyTimePoint2`,
    b_ot2_Age5 = b_ot2 + `b_ot2:StudyTimePoint3`,
    b_ot3_Age3 = b_ot3,
    b_ot3_Age4 = b_ot3 + `b_ot3:StudyTimePoint2`,
    b_ot3_Age5 = b_ot3 + `b_ot3:StudyTimePoint3`,
    b_Intercept_Prop_Age3 = plogis(b_Intercept_Age3),
    b_Intercept_Prop_Age4 = plogis(b_Intercept_Age4),
    b_Intercept_Prop_Age5 = plogis(b_Intercept_Age5),
    d_Intercept_Age4 = b_Intercept_Age4 - b_Intercept_Age3,
    d_Intercept_Age5 = b_Intercept_Age5 - b_Intercept_Age4,
    d_Intercept_Prop_Age4 = b_Intercept_Prop_Age4 - b_Intercept_Prop_Age3,
    d_Intercept_Prop_Age5 = b_Intercept_Prop_Age5 - b_Intercept_Prop_Age4,
    d_Intercept_Prop_Age5_3 = b_Intercept_Prop_Age5 - b_Intercept_Prop_Age3,
    d_ot1_Age4 = b_ot1_Age4 - b_ot1_Age3,
    d_ot1_Age5 = b_ot1_Age5 - b_ot1_Age4,
    d_ot2_Age4 = b_ot2_Age4 - b_ot2_Age3,
    d_ot2_Age5 = b_ot2_Age5 - b_ot2_Age4,
    d_ot3_Age4 = b_ot3_Age4 - b_ot3_Age3,
    d_ot3_Age5 = b_ot3_Age5 - b_ot3_Age4)

mcmc_intervals(test, regex_pars = "Intercept_A")
mcmc_intervals(test, regex_pars = "Intercept_Prop")
mcmc_intervals(test, regex_pars = "ot1_Age")
mcmc_intervals(test, regex_pars = "ot2_Age")
mcmc_intervals(test, regex_pars = "ot3_Age")
mcmc_intervals(test, regex_pars = "Intercept_Prop")
mcmc_intervals(test, regex_pars = "Age")
```


When children start on the image of a novel object and hear a
mispronunciation, they tend to look to the familiar image.
Figure \@ref(fig:unfam-initial-mp-trials) shows the average of
children's growth curves along with the 100 model-estimated group
averages. The growth curves all cross the .5 threshold, so that the
children on average looked more to the familiar image than the unfamilar
image. Granted, the degree of referent selection here is not as great as
that observed for the nonwords or real words. For those conditions, the
average growth curves reached a peak of around .77 at age 3 whereas for
the mispronunciations the age-3 peak is around .62. Children were slower
to process mispronunciations. For the real-word condition, the average
age 3 growth curve crosses .5 looking probability around 775 ms after
target onset whereas in the mispronunciation condition, this threshold
is crossed at 1000 ms. Children associate the mispronunciation with the
familiar object, although they are slower and show greater uncertainty.

(ref:unfam-initial-mp-trials) Averages of participants' growth curves in
each age. The lines represent 100 posterior predictions of
the group average. 

```{r unfam-initial-mp-trials, fig.cap = "(ref:unfam-initial-mp-trials)", fig.width = 5, fig.height = 4, out.width = "80%"}
newdata <- d_u %>% 
  distinct(Study, ResearchID, Time, ot1, ot2, ot3) %>% 
  mutate(Target = 0, Trials = 30)

m_u_new_fits <- augment_linpred(
  mp_unfam, newdata, nsamples = 100, allow_new_levels = TRUE) %>% 
  mutate(Study = convert_study_to_age(Study)) %>% 
  group_by(Study, .draw, Time) %>% 
  summarise(Prop = mean(plogis(.posterior_value))) %>% 
  group_by(Study, .draw)

df_u_label <- tibble::tribble(
  ~Study, ~Time, ~Prop,
  "Age 3", 1050, .42,
  # "Age 4", 1000, .42,
  "Age 5", 1300, .72)

d_u_plotting <- d_u %>% 
  mutate(Study = convert_study_to_age(Study)) 

ggplot(d_u_plotting) + 
  aes(x = Time, y = Prop, color = Study) + 
  geom_hline(yintercept = .5, size = 2, color = "white") +
  stat_summary(fun.data = mean_se, geom = "pointrange") + 
  geom_line(aes(group = .group), data = m_u_new_fits, alpha = .05) +
  geom_text(
    aes(label = Study),
    data = df_u_label,
    size = 5, 
    family = "Lato Semibold") +
  geom_text(
    aes(label = label),
    data = data_frame(
      Time = 425, 
      Prop = .11, 
      label = constants$note_mp_unfam),
    size = 3, 
    hjust = 0,
    color = constants$col_off_black,
    family = "Lato") +
  scale_color_study() + 
  expand_limits(y = .76) +
  guides(color = FALSE) +
  labs(
    x = constants$x_time,
    y = constants$y_prop_fam,
    caption = constants$cap_emp_and_draw)
```

Of the growth curve features, developmental changes were only observed
for the intercept and peak probability features. At age 3, the average
proportion of looks to the familiar image was
`r i_ints$b_Intercept_Prop_Age3`. The looking proportion increased by
`r i_ints$d_Intercept_Prop_Age4` to `r i_ints$b_Intercept_Prop_Age4` at
age 4. This year-over-year change is probably positive, but a change
of 0 is still a plausible result. Visually, this uncertainty appears in
the growth curve plot by how close together the age-3 and age-4 growth
curves appear. The average proportion of looks increased by
`r i_ints$d_Intercept_Prop_Age5` to `r i_ints$b_Intercept_Prop_Age5` at
age 5. Here, there is more certainty that the year-over-year change was
positive. In short, performance was similar for age 3 and age 4 but
there was a marked improvement at age 5.

Figure \@ref(fig:unfam-peaks-by-age) shows participant's growth curve
peaks for each year of the study. The average of the participant's
growth curve peaks followed the same pattern as the intercept: similar
levels at age 3 and age 4 (`r group_peaks[["Age 3"]]` versus
`r group_peaks[["Age 4"]]`) but a clear gain in looking peak probability
at age 5 (`r group_peaks[["Age 5"]]`). Unlike the nonword conditions,
very few listeners achieve a peak of looking probability of .1.

None of the other growth curve features showed developmental changes.
That is, There were no credible year-over-year changes for the linear,
quadratic or cubic time components of the growth curve. Although
Figure \@ref(fig:unfam-initial-mp-trials) shows children's probability
of looking to the familiar image increasing sharply at age 5, this
effect cannot be clear tied to any of the model's polynomial time
features. After about 600 ms, the age 5 curve is almost parallel to
other curves. This is consistent with the intercept effect: The
curve is higher than the others on average, but it doesn't show any
differences in shape.

```{r unfam-peaks-by-age, fig.cap = "(ref:unfam-peaks-by-age)", fig.width=4, fig.height=3, out.width="50%"}
study_peak_counts <- unfam_peaks %>%
  distinct(Study, ResearchID) %>%
  mutate(
    Study = Study %>% convert_study_to_age(),
    StudyCounts = Study %>% fct_add_counts()) %>%
  distinct(Study, StudyCounts)

x_levels <- setNames(
  as.character(study_peak_counts$StudyCounts), 
  as.character(study_peak_counts$Study))


unfam_peaks %>% 
  mutate(
    Study = convert_study_to_age(Study),
    Peak = plogis(med)) %>% 
  group_by(Study, ResearchID) %>% 
  summarise_at(vars(Time, Peak), mean, na.rm = TRUE) %>% 
  ggplot() + 
    aes(x = Study, y = Peak) + 
    geom_hline(yintercept = .5, size = 2, color = "white") + 
    geom_boxplot(width = .4, fill = NA, outlier.alpha = 0) +
    geom_point(
      position = position_jitter(width = .2), 
      alpha = .4, 
      shape = 1) + 
    # geom_text(
    #   aes(label = label),
    #   data = data_frame(
    #     Peak = 1.04, 
    #     label = constants$note_mp_unfam,
    #     Study = "Age 3"), 
    #   hjust = .1,
    #   # position = position_dodge(width = 1.15), 
    #   size = 3, 
    #   family = "Lato") +
    labs(
      title = "Growth curve peaks",
      subtitle = constants$note_mp_unfam,
      x = NULL,
      y = NULL,
      caption = "Points: Participant posterior means.") + 
    scale_x_discrete(labels = x_levels) +
    theme(plot.subtitle = element_text(size = rel(.9)))
```

**Summary**. When children look at the unfamilar object and hear a
mispronunciation, they on average look to the familiar image that sounds
like the mispronunciation. Children are much more uncertain in this
condition, compared to the conditions whether appropriate referent is
more obvious. The only development changes observed were the increases
in looking reliability and peak looking probability at age 5.


## Familiar-initial trials

Preschoolers associate one-feature onset-mispronunciations with the
familiar word that matches the rime of the word. 

Figure XX shows the growth curve averages for trials starting on the
familiar image. Here the looking patterns show a rush into uncertainty.
At age 3 and age 4, the growth sharply decrease into chance
level-performance. Behaviorally, they are looking to both images
equally. One interpretation of this pattern is that the children are
making brief confirmatory looks to the novel image; they checking out
the novel image. But this cannot be right because the growth curve never
dips much below .5 (certainly not below .4). So there is more likely a
mix of behaviors, with children staying put on some trials and
considering the novel object on some trials.

```{r fam-initial-mp-trials, fig.width=5, fig.height=4, out.width="80%"}
f_newdata <- d_f %>% 
  distinct(Study, ResearchID, Time, ot1, ot2, ot3) %>% 
  mutate(Target = 0, Trials = 30)

m_f_new_fits <- augment_linpred(
  mp_fam, f_newdata, nsamples = 100, allow_new_levels = TRUE) %>% 
  mutate(Study = convert_study_to_age(Study)) %>% 
  group_by(Study, .draw, Time) %>% 
  summarise(Prop = mean(plogis(.posterior_value))) %>% 
  group_by(Study, .draw)

df_f_label <- tibble::tribble(
  ~Study, ~Time, ~Prop,
  "Age 3", 650, .80,
  "Age 4", 1000, .41,
  "Age 5", 1400, .66)

df_f_plotting <- d_f %>% 
  mutate(Study = convert_study_to_age(Study)) 

ggplot(df_f_plotting) + 
  aes(x = Time, y = Prop, color = Study) + 
  geom_hline(yintercept = .5, size = 2, color = "white") +
  stat_summary(fun.data = mean_se, geom = "pointrange") + 
  geom_line(aes(group = .group), data = m_f_new_fits, alpha = .05) +
  geom_text(
    aes(label = label),
    data = data_frame(
      Time = 410, 
      Prop = .93, 
      label = constants$note_mp_fam),
    size = 3, 
    hjust = 0,
    color = constants$col_off_black,
    family = "Lato") +
  scale_color_study() + 
  expand_limits(y = .38) +
  guides(color = FALSE) +
  labs(
    x = constants$x_time,
    y = constants$y_prop_fam,
    caption = constants$cap_emp_and_draws)
```



I asked whether growth curve "valleys" provided a meaningful feature for
this data. This value was defined as the median of the five smallest
proportions of a growth curve. It reflects the maximum degree to which
the novel image is considered as a referent for the mispronunciation.


```{r fam-peaks-by-age, fig.width=4, fig.height=3, out.width="50%"}
study_peak_counts <- fam_peaks %>%
  distinct(Study, ResearchID) %>%
  mutate(
    Study = Study %>% convert_study_to_age(),
    StudyCounts = Study %>% fct_add_counts()) %>%
  distinct(Study, StudyCounts)

x_levels <- setNames(
  as.character(study_peak_counts$StudyCounts), 
  as.character(study_peak_counts$Study))

fam_peaks %>% 
  mutate(
    Study = convert_study_to_age(Study),
    Peak = plogis(med)) %>% 
  group_by(Study, ResearchID) %>% 
  summarise_at(vars(Time, Peak), mean, na.rm = TRUE) %>% 
    ggplot() + 
      aes(x = Study, y = Peak) + 
      geom_hline(yintercept = .5, size = 2, color = "white") + 
      geom_boxplot(width = .4, fill = NA, outlier.alpha = 0) +
      geom_point(position = position_jitter(width = .2), alpha = .3, shape = 1) + 
      labs(
        title = "Growth curve valleys",
        subtitle = constants$note_mp_fam,
        x = NULL,
        y = NULL,
        caption = "Points: Participant posterior means.") + 
    scale_x_discrete(labels = x_levels) +
    theme(plot.subtitle = element_text(size = rel(.9)))
```



```{r explore-intervals2, eval = FALSE}
test <- posterior_samples(mp_fam, pars = "^b_") %>% 
  mutate(
    b_Intercept_Age3 = b_Intercept,
    b_Intercept_Age4 = b_Intercept + b_StudyTimePoint2,
    b_Intercept_Age5 = b_Intercept + b_StudyTimePoint3,
    b_ot1_Age3 = b_ot1,
    b_ot1_Age4 = b_ot1 + `b_ot1:StudyTimePoint2`,
    b_ot1_Age5 = b_ot1 + `b_ot1:StudyTimePoint3`,
    b_ot2_Age3 = b_ot2,
    b_ot2_Age4 = b_ot2 + `b_ot2:StudyTimePoint2`,
    b_ot2_Age5 = b_ot2 + `b_ot2:StudyTimePoint3`,
    b_ot3_Age3 = b_ot3,
    b_ot3_Age4 = b_ot3 + `b_ot3:StudyTimePoint2`,
    b_ot3_Age5 = b_ot3 + `b_ot3:StudyTimePoint3`,
    b_Intercept_Prop_Age3 = plogis(b_Intercept_Age3),
    b_Intercept_Prop_Age4 = plogis(b_Intercept_Age4),
    b_Intercept_Prop_Age5 = plogis(b_Intercept_Age5),
    d_Intercept_Age4 = b_Intercept_Age4 - b_Intercept_Age3,
    d_Intercept_Age5 = b_Intercept_Age5 - b_Intercept_Age4,
    d_Intercept_Prop_Age4 = b_Intercept_Prop_Age4 - b_Intercept_Prop_Age3,
    d_Intercept_Prop_Age5 = b_Intercept_Prop_Age5 - b_Intercept_Prop_Age4,
    d_Intercept_Prop_Age5_3 = b_Intercept_Prop_Age5 - b_Intercept_Prop_Age3,
    d_ot1_Age4 = b_ot1_Age4 - b_ot1_Age3,
    d_ot1_Age5 = b_ot1_Age5 - b_ot1_Age4,
    d_ot2_Age4 = b_ot2_Age4 - b_ot2_Age3,
    d_ot2_Age5 = b_ot2_Age5 - b_ot2_Age4,
    d_ot3_Age4 = b_ot3_Age4 - b_ot3_Age3,
    d_ot3_Age5 = b_ot3_Age5 - b_ot3_Age4)

mcmc_intervals(test, regex_pars = "Intercept_A")
mcmc_intervals(test, regex_pars = "Intercept_Prop")
mcmc_intervals(test, regex_pars = "ot1_Age")
mcmc_intervals(test, regex_pars = "ot2_Age")
mcmc_intervals(test, regex_pars = "ot3_Age")
mcmc_intervals(test, regex_pars = "Intercept_Prop")
mcmc_intervals(test, regex_pars = "Age")
```


## Discussion

Children





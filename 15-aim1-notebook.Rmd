# Visualize looks to each image type

We continue our exploration of the raw data by aggregating looks to each image 
type. 

```{r include = FALSE}
knitr::read_chunk("./helpers.R")
if (interactive()) source("./helpers.R")
```

```{r helpers, include = FALSE}
```

Earlier we cleaned the data to remove trials with excessive missing data 
and blocks of trials with too few trials. Read in that data.

```{r, message = FALSE, warnings = FALSE, echo = FALSE, message = FALSE}
data <- readr::read_csv("./data/aim1-screened.csv.gz")
```

Plot growth curves to each AOI.

```{r by-aoi-prop, out.width = "100%", fig.height=2.5, fig.width=6, echo = FALSE, message = FALSE}
resp_def <- create_response_def(
  primary = "Target",
  others = c("PhonologicalFoil", "SemanticFoil", "Unrelated"),
  elsewhere = "tracked",
  missing = NA
)

defs <- cycle_response_def(resp_def)

# We use this later on
semy_defs <- defs %>% 
  purrr::keep(~ .x$primary %in% c("Target", "SemanticFoil")) 
phon_defs <- defs %>% 
  purrr::keep(~ .x$primary %in% c("Target", "PhonologicalFoil"))

# Aggregate looks using each rule
looks_by_aoi <- data %>% 
  aggregate_looks(defs, Study + ResearchID + Time ~ GazeByImageAOI) %>% 
  rename(AOI = .response_def) %>% 
  select(AOI:Time, Prop, Primary, Unrelated) %>% 
  mutate(AOI = factor(AOI, c("Target", "PhonologicalFoil", 
                             "SemanticFoil", "Unrelated")))
  
ggplot(looks_by_aoi) + 
  aes(x = Time, y = Prop, color = Study) + 
  geom_hline(size = 2, color = "white", yintercept = .25) +
  stat_smooth() + 
  facet_grid( ~ AOI) + 
  labs(
    x = "Time after target onset [ms]",
    y = "Proportion looking to image",
    caption = "GAM smooth on partially screened data") +
  theme_grey(base_size = 9) +
  theme(
    legend.position = c(0.95, 0.95), 
    legend.justification = c(1, 1))
```

The looks to target increase year over year which decreases the remaining
proportion of looks for the other three images each year. To study the relative
propensity of looking to each image, we instead can use the log-odds of looking
to each AOI versus the unrelated image.

```{r by-aoi-logit, out.width = "100%", fig.height=2.5, fig.width=6, echo = FALSE, message = FALSE}
ggplot(looks_by_aoi %>% filter(AOI != "Unrelated")) + 
  aes(x = Time, y = log(Primary / Unrelated), color = Study) + 
  geom_hline(size = 2, color = "white", yintercept = 0) +
  stat_smooth() + 
  facet_grid( ~ AOI) + 
  labs(
    x = "Time after target onset [ms]",
    y = "Log odds looking to word vs. unrelated word",
    caption = "GAM smooth on partially screened data") +
  theme_grey(base_size = 9) +
  theme(
    legend.position = c(0.95, 0.95), 
    legend.justification = c(1, 1))
```

Each curve is the log odds of looking to the target, phonological foil, and
semantic foil versus the unrelated word. Positive values mean more looks to an
image type than the unrelated. If you think of the _y_ axis as the image's
_relatedness_ to the target, you can see a time course of relatedness in each
panel: Here early phonological effects meaning early relatedness and later,
flatter semantic effects meaning late relatedness. (These effects make even more
sense sense if phonological representations affect processing before semantic
ones.)

This plot suggests an important finding: Children becoming more sensitive to the
phonological and semantic foils as they grow older. (I use the verb *suggest*
because this is still a preliminary, unmodeled finding.) Jan and I had made
opposite predictions about whether this would happen. Her argument, I think, was
that children become better at word recognition by becoming better able to
inhibit interference from competing words. This plot would suggest that they
show increased sensitive to the target and foils words by looking less to the
unrelated word as they age and reapportioning those looks to the other three
lexically relevant words.

## Comparing strong versus weak foils

In @RWLPaper, we ignored trials for certain items where we didn't think the
phonological or semantic similarity was strong enough. The two sets of
phonological foils are shown below.

```{r print-phon-foil-tables, message = FALSE, echo = FALSE}
trial_info <- bind_rows(
  readr::read_csv("data-raw/rwl_timepoint1_trials.csv.gz"),
  readr::read_csv("data-raw/rwl_timepoint2_trials.csv.gz"),
  readr::read_csv("data-raw/rwl_timepoint3_trials.csv.gz")) %>% 
  select(
    TrialID, Target = WordTarget, PhonologicalFoil = WordPhonologicalFoil,
    SemanticFoil = WordSemanticFoil, 
    Unrelated = WordUnrelated)

good_phono <- c("bear", "bee", "bell", "dress", "drum", "flag", "fly", 
                "heart", "horse", "pan", "pear", "pen", "vase")

good_semy <- c("bear", "bee", "bell", "bread", "cheese", "dress", 
               "drum", "fly", "horse", "pan", "pear", "shirt", "spoon")

words <- trial_info %>% 
  distinct(Target, PhonologicalFoil, SemanticFoil, Unrelated)

phono_foils <- split(words, words$Target %in% good_phono) %>% 
  lapply(arrange, Target) %>% 
  setNames(c("weak_foil", "strong_foil"))

semy_foils <- split(words, words$Target %in% good_semy) %>% 
  lapply(arrange, Target) %>% 
  setNames(c("weak_foil", "strong_foil"))

phono_foils$strong_foil %>% 
  knitr::kable(caption = "Trials with strong phonological foils.")

phono_foils$weak_foil %>% 
  knitr::kable(caption = "Trials with weak phonological foils.")
```

The stronger phonological foils are pairs where the syllable onsets are the
same. The weaker foils include rime pairs, pairs where the words have
different syllable onsets, and pairs where the onsets differ by a phonetic
feature.

```{r print-semy-foil-tables, message = FALSE, echo = FALSE}
semy_foils$strong_foil %>% 
  knitr::kable(caption = "Trials with strong semantic foils.")

semy_foils$weak_foil %>% 
  knitr::kable(caption = "Trials with weak semantic foils.")
```

The strong semantic foils belong to the same category and the weaker ones have a
less obvious relationship (*ring* and *dress*).

We visually confirm that the strong versus weak foils behave differently.

```{r by-aoi-logit-foils, out.width = "100%", fig.height=2.5, fig.width=6, echo = FALSE, message = FALSE}
weak_phon_looks <- trial_info %>% 
  semi_join(phono_foils$weak_foil) %>% 
  inner_join(data) %>% 
  mutate(PhonFoil = "Weak")

strong_phon_looks <- trial_info %>% 
  semi_join(phono_foils$strong_foil) %>% 
  inner_join(data) %>% 
  mutate(PhonFoil = "Strong")

phon_data <- bind_rows(strong_phon_looks, weak_phon_looks)

weak_semy_looks <- trial_info %>% 
  semi_join(semy_foils$weak_foil) %>% 
  inner_join(data) %>% 
  mutate(SemyFoil = "Weak")

strong_semy_looks <- trial_info %>% 
  semi_join(semy_foils$strong_foil) %>% 
  inner_join(data) %>% 
  mutate(SemyFoil = "Strong")

phon_data <- bind_rows(strong_phon_looks, weak_phon_looks)
semy_data <- bind_rows(weak_semy_looks, strong_semy_looks)

looks_by_aoi2 <- phon_data %>% 
  aggregate_looks(
    phon_defs, 
    Study + ResearchID + PhonFoil + Time ~ GazeByImageAOI) %>% 
  rename(AOI = .response_def) %>% 
  select(AOI:Time, PhonFoil, Prop, Primary, PhonologicalFoil, Unrelated) %>% 
  mutate(
    AOI = factor(
      AOI, c("Target", "PhonologicalFoil", "SemanticFoil", "Unrelated")))

looks_by_aoi3 <- semy_data %>% 
  aggregate_looks(
    semy_defs, Study + ResearchID + SemyFoil + Time ~ GazeByImageAOI) %>% 
  rename(AOI = .response_def) %>% 
  select(AOI:Time, SemyFoil, Prop, Primary, SemanticFoil, Unrelated) %>% 
  mutate(
    AOI = factor(
      AOI, c("Target", "PhonologicalFoil", "SemanticFoil", "Unrelated")))

ggplot(looks_by_aoi2 %>% filter(AOI != "Unrelated")) + 
  aes(
    x = Time, y = log(Primary / Unrelated), 
    color = Study, linetype = PhonFoil) + 
  geom_hline(size = 2, color = "white", yintercept = 0) +
  stat_smooth() + 
  facet_grid( ~ AOI) + 
  labs(
    x = "Time after target onset [ms]",
    y = "Log odds looking to word vs. unrelated word",
    caption = "GAM smooth on partially screened data") +
  theme_grey(base_size = 9) 

ggplot(looks_by_aoi3 %>% filter(AOI != "Unrelated")) + 
  aes(
    x = Time, y = log(Primary / Unrelated), 
    color = Study, linetype = SemyFoil) + 
  geom_hline(size = 2, color = "white", yintercept = 0) +
  stat_smooth() + 
  facet_grid( ~ AOI) + 
  labs(
    x = "Time after target onset [ms]",
    y = "Log odds looking to word vs. unrelated word",
    caption = "GAM smooth on partially screened data") +
  theme_grey(base_size = 9) 
```

What's going on here:

- The weak phonological foils are indeed weaker than the strong foils.
- The strong semantic foils appear stronger than the weak ones. The strong
  foils show a growth curve pattern of increasing looks away from baseline and
  there a developmental difference among the growth curves for each time
  point.
- Children have a lower advantage for the target (vs unrelated) in weak foil
  trials because... why? My reading is that if the semantic or phonological
  foil is effective, children will look at it instead of the unrelated image.
  Conversely, if the semantic or phonological foil are less effective,
  children will look more to the unrelated image, which pulls down the ratio
  of looks to target versus the unrelated image.

In the above plots, we fixed the denominator to be the number of looks to the
unrelated image and varied the numerator. In the plots below, we fix the
numerator to be the looks to the target and vary the denominator to looks to
target versus looks to each foil.

```{r by-aoi-logit-target-phon, out.width = "100%", fig.height=2.5, fig.width=6, echo = FALSE, message = FALSE}
semantic_target_curves <- looks_by_aoi3 %>% 
  filter(AOI == "Target") %>% 
  mutate(
    `Target vs Semantic` = log(Primary / SemanticFoil), 
    `Target vs Unrelated` = log(Primary / Unrelated)) %>% 
  tidyr::gather(
    "Comparison", "LogOdds", 
    `Target vs Semantic`, `Target vs Unrelated`) 
  
phonological_target_curves <- looks_by_aoi2 %>% 
  filter(AOI == "Target") %>% 
  mutate(
    `Target vs Phonological` = log(Primary / PhonologicalFoil), 
    `Target vs Unrelated` = log(Primary / Unrelated)) %>% 
  tidyr::gather(
    "Comparison", "LogOdds", 
    `Target vs Phonological`, `Target vs Unrelated`) 
  
ggplot(phonological_target_curves) + 
  aes(x = Time, y = LogOdds, color = Study, linetype = PhonFoil) + 
  geom_hline(size = 2, color = "white", yintercept = 0) +
  stat_smooth() + 
  facet_grid( ~ Comparison) + 
  labs(
    x = "Time after target onset [ms]",
    y = "Log odds looking",
    caption = "GAM smooth on partially screened data") +
  theme_grey(base_size = 9) 
```

Curves in both panels attain the same height, so phonological and unrelated foils 
affect processing equally later in the trial. The strong phonological foils 
curves in the Target vs Phonological comparison rise later than the weak foils, 
reflecting early looks to the phonological foils.

```{r by-aoi-logit-target-semi, out.width = "100%", fig.height=2.5, fig.width=6, echo = FALSE, message = FALSE}
ggplot(semantic_target_curves) + 
  aes(x = Time, y = LogOdds, color = Study, linetype = SemyFoil) + 
  geom_hline(size = 2, color = "white", yintercept = 0) +
  stat_smooth() + 
  facet_grid( ~ Comparison) + 
  labs(
    x = "Time after target onset [ms]",
    y = "Log odds looking",
    caption = "GAM smooth on partially screened data") +
  theme_grey(base_size = 9) 
```

Curves in the two panels do not attain the same height, so the semantic foil
reduces odds of fixating to the target later on in a trial. There appears to be
no difference in strong and weak foils in Year 2 and Year 3, so I might be able
to collapse to remove this distinction and include more items in the analysis.


## Preparing data for the model

```{r, echo = FALSE}
opts_model <- list(
  bin_width = 3,
  start_time = 250,
  end_time = 1500
)
opts_model$bin_length <- round(opts_model$bin_width * 16.67, -1)
message("Modelling options: ")
message(str(opts_model))
```

As in the earlier models, we downsampled the data into
`r opts_model$bin_length`-ms (`r opts_model$bin_width`-frame) bins in order to
smooth the data. We modeled the looks from `r opts_model$start_time` to
`r opts_model$end_time` ms. Lastly, we aggregated looks by child, study and
time, and created orthogonal polynomials to use as time features for the model


```{r, echo = FALSE, message = FALSE}
data <- strong_phon_looks %>% 
  select(Study, ResearchID, TrialID:GazeByImageAOI) %>% 
  assign_bins(bin_width = opts_model$bin_width, Time, TrialID)

# Compute time at center of each bin
bin_times <- data %>% 
  distinct(Time, .bin) %>% 
  group_by(.bin) %>% 
  mutate(BinTime = round(median(Time), -1)) %>% 
  ungroup()

# Attach bin times
binned <- data %>% 
  left_join(bin_times, by = c("Time", ".bin")) %>% 
  ungroup() %>% 
  select(-Time) %>% 
  rename(Time = BinTime) 

d <- binned %>% 
  aggregate_looks(phon_defs, Study + ResearchID + Time ~ GazeByImageAOI)

phon_d <- d %>% 
  filter(
    opts_model$start_time <= Time, 
    Time <= opts_model$end_time) %>% 
  polypoly::poly_add_columns(
    Time, degree = 3, scale_width = 1, prefix = "ot") %>% 
  rename(Focus = .response_def)

phon_d %>%
  sample_n_of(9, ResearchID) %>%
  ggplot() +
    aes(
      x = Time, y = log(Primary / Unrelated), 
      color = Study, linetype = Focus) +
    geom_line(aes(group = interaction(Study, Focus))) +
    facet_wrap("ResearchID")

# phon_d %>%
#   # sample_n_of(50, ResearchID) %>%
#   ggplot() +
#     aes(x = Time, y = log(Primary / Unrelated), color = Study, linetype = Focus) +
#     stat_summary(fun.y = mean, geom = "line")
```

```{r}
# library(lme4)
# m <- glmer(
#  cbind(Primary, Unrelated) ~
#         Study * (ot1 + ot2 + ot3) +
#         (ot1 + ot2 + ot3 | ResearchID) +
#         (ot1 + ot2 + ot3 | Study:ResearchID),
#   family = binomial,
#   data = phon_d %>% filter(Focus == "PhonologicalFoil"))

```

The final model should looks like this. I'll have to run this for a few days.

```{r}
phon_d <- phon_d %>% 
  filter(Focus == "PhonologicalFoil")
```


```{r, eval = FALSE}
library(rstanarm)
options(mc.cores = parallel::detectCores())

m <- stan_glmer(
 cbind(Primary, Unrelated) ~ 
        Study * (ot1 + ot2 + ot3) + 
        (ot1 + ot2 + ot3 | ResearchID) + 
        (ot1 + ot2 + ot3 | Study:ResearchID),
  family = binomial,
  prior = normal(0, 1, autoscale = FALSE),
  prior_intercept = normal(0, 2),
  prior_covariance = decov(2, 1, 1),
  control = list(adapt_delta = .99),
  data = phon_d)
readr::write_rds(m, "./data/stan_aim1_phon_model2.rds.gz")
```

For this model structure, we estimate two growth curves simultaneously for each
year of the study. Each growth curve is the log-odds of fixating on a certain
image relative to the unrelated image. We use an indicator variable *focus* to
record whether the image is the target or the phonological foil. 

Actually, I am not sure I need to estimate two growth curves simulataneously
yet. I could just estimate log-odds of looking to Phonological vs Unrelated
directly. This would let me estimate year over year changes, the time course of
the effects and maybe some individual differences in looks to the phonological
foil. I could posterior-predict looks at each time bin and see how the 
intervals compare to zero.


Hmmm, this is not working quite right yet.

```{r, eval = FALSE, echo = FALSE}
library(rstanarm)
okay <- readr::read_rds("./data/stan_aim1_phon_model2.rds.gz")
summary(okay, pars = names(fixef(okay)))

sims <- rstanarm::posterior_predict(okay, draws = 200, seed = "09272017")
n_trials <- data_frame(y_id = seq_along(okay$y[, 1]), n_trials = rowSums(okay$y))

length(phon_d$Study)
length(okay$y[, 1])

bayesplot:::ppc_data(okay$y[, 1], sims, group = phon_d$Study) %>% 
  left_join(n_trials, by = "y_id") %>% 
  mutate(prop = value / n_trials) %>% 
  ggplot() +
    aes(x = prop) +
    stat_density(
      aes_(group = ~ rep_id),
      data = function(x) dplyr::filter(x, !.data$is_y),
      geom = "line", position = "identity", size = .25, alpha = .1, 
      color = "#0074D9") +
    stat_density(
      data = function(x) dplyr::filter(x, .data$is_y),
      geom = "line", position = "identity", size = 1) + 
    labs(x = "Proportion of looks", 
         title = "Observed data and 200 posterior simulations") + 
    coord_cartesian(xlim = c(0, 1), expand = FALSE) + 
    facet_wrap("group")
```




## Look for individual differences in competitor sensitivity

[...put this on hold for a while...]

<!-- Let's just run with all the foils. There's a trade-off here about sparsity and -->
<!-- strength of the stimuli. -->

```{r, eval = FALSE, out.width = "100%", echo = FALSE}
# Downsample to 50 ms bins
d <- phon_data %>% 
  filter(-467 <= Time) %>% 
  # filter(PhonFoil == "Strong") %>% 
  assign_bins(bin_width = 3, Time, TrialID) %>% 
  group_by(TrialID, .bin) %>% 
  mutate(BinTime = round(median(Time), -1)) %>% 
  ungroup() %>% 
  aggregate_looks(phon_defs, Study + ResearchID + BinTime ~ GazeByImageAOI)

ggplot(d %>% filter(.response_def == "PhonologicalFoil")) + 
  aes(x = BinTime, y = empirical_logit(PhonologicalFoil, Unrelated)) + 
  geom_line(aes(group = ResearchID), alpha = .2) + 
  stat_smooth() +
  facet_grid(. ~ Study)

d_m <- d %>% 
  filter(250 <= BinTime, BinTime <= 1500) %>% 
  filter(.response_def == "PhonologicalFoil") %>% 
  polypoly::poly_add_columns(BinTime, degree = 3, 
                             scale_width = 1, prefix = "ot")

ggplot(d_m %>% filter(.response_def == "PhonologicalFoil")) + 
  aes(x = BinTime, y = empirical_logit(PhonologicalFoil, Unrelated)) + 
  geom_line(aes(group = ResearchID), alpha = .2) + 
  stat_smooth() +
  facet_grid(. ~ Study)


# m <- glmer(
#   cbind(PhonologicalFoil, Unrelated) ~ 
#     (ot1 + ot2 + ot3) * Study + 
#     (ot1 + ot2 + ot3 | ResearchID), 
#   family = binomial,
#   data = d_m)
# summary(m)
```

```{r, eval = FALSE, echo = FALSE}
library(lme4)
fx <- . %>% 
  glmer(
    cbind(PhonologicalFoil, Unrelated) ~
      (ot1 + ot2 + ot3) +
      (ot1 + ot2 + ot3 | ResearchID),
    family = binomial,
    data = .)

by_study <- d_m %>% 
  tidyr::nest(-Study) %>% 
  mutate(model = purrr::map(data, fx))


lapply(by_study$model, summary)

by_study <- by_study %>% 
  mutate(data = purrr::map2(model, data, broom::augment))



data
size = 10
tidyr::unnest(by_study, data) %>% 
  sample_n_of(12, ResearchID) %>% 
  ggplot() + 
  aes(x = BinTime, y = .fitted, color = Study) + 
  geom_point() + 
  geom_line(aes(group = interaction(ResearchID, Study))) + 
  facet_wrap("ResearchID")
```

## Interim summary

* Visual evidence that the semantic foil and phonological foil become more 
  relevant (compared to unrelated foil) each year. 
* Our previous distinction between strong and weak foils still applies, 
  although it might be better to exclude only the (a priori) weakest foils, 
  like the rime phonological foils.

# Visualize looks to each image type

We continue our exploration of the raw data by aggregating looks to each image 
type. 

```{r include = FALSE}
knitr::read_chunk("./helpers.R")
if (interactive()) source("./helpers.R")
```

```{r helpers, include = FALSE}
```

Earlier we cleaned the data to remove trials with excessive missing data 
and blocks of trials with too few trials. Read in that data.

```{r, message = FALSE, warnings = FALSE, echo = FALSE, message = FALSE}
data <- readr::read_csv("./data/aim1-screened.csv.gz")
recode_studies <- tibble::tribble(
  ~S, ~Study, ~Age,
  "TimePoint1", "TimePoint1", "Age 3",
  "TimePoint2", "TimePoint2", "Age 4",
  "TimePoint3", "TimePoint3", "Age 5",
)
convert_study_to_age <- function(xs) {
  factor(
    xs, 
    levels = c("TimePoint1", "TimePoint2", "TimePoint3"), 
    labels = c("Age 3", "Age 4", "Age 5"))
}
```

Plot growth curves to each AOI.

```{r by-aoi-prop, out.width = "100%", fig.height=2.5, fig.width=6, echo = FALSE, message = FALSE}
resp_def <- create_response_def(
  primary = "Target",
  others = c("PhonologicalFoil", "SemanticFoil", "Unrelated"),
  elsewhere = "tracked",
  missing = NA
)

defs <- cycle_response_def(resp_def)

# We use this later on
semy_defs <- defs %>% 
  purrr::keep(~ .x$primary %in% c("Target", "SemanticFoil")) 
phon_defs <- defs %>% 
  purrr::keep(~ .x$primary %in% c("Target", "PhonologicalFoil"))

# Aggregate looks using each rule
looks_by_aoi <- data %>% 
  aggregate_looks(defs, Study + ResearchID + Time ~ GazeByImageAOI) %>% 
  rename(AOI = .response_def) %>% 
  select(AOI:Time, Prop, Primary, Unrelated) %>% 
  mutate(AOI = factor(AOI, c("Target", "PhonologicalFoil", 
                             "SemanticFoil", "Unrelated")))
  
ggplot(looks_by_aoi) + 
  aes(x = Time, y = Prop, color = Study) + 
  geom_hline(size = 2, color = "white", yintercept = .25) +
  stat_smooth() + 
  facet_grid( ~ AOI) + 
  labs(
    x = "Time after target onset [ms]",
    y = "Proportion looking to image",
    caption = "GAM smooth") +
  theme_grey(base_size = 9) +
  theme(
    legend.position = c(0.95, 0.95), 
    legend.justification = c(1, 1))
```



The looks to target increase year over year which decreases the remaining
proportion of looks for the other three images each year. To study the relative
propensity of looking to each image, we instead can use the log-odds of looking
to each AOI versus the unrelated image.

```{r by-aoi-logit, out.width = "100%", fig.height=2.5, fig.width=6, echo = FALSE, message = FALSE}
ggplot(looks_by_aoi %>% filter(AOI != "Unrelated")) + 
  aes(x = Time, y = log(Primary / Unrelated), color = Study) + 
  geom_hline(size = 2, color = "white", yintercept = 0) +
  stat_smooth() + 
  facet_grid( ~ AOI) + 
  labs(
    x = "Time after target onset [ms]",
    y = "Log odds looking to word vs. unrelated word",
    caption = "GAM smooth") +
  theme_grey(base_size = 9) +
  theme(
    legend.position = c(0.95, 0.95), 
    legend.justification = c(1, 1))
```

Each curve is the log odds of looking to the target, phonological foil, and
semantic foil versus the unrelated word. Positive values mean more looks to an
image type than the unrelated. If you think of the _y_ axis as the image's
_relatedness_ to the target, you can see a time course of relatedness in each
panel: Here early phonological effects meaning early relatedness and later,
flatter semantic effects meaning late relatedness. (These effects make even more
sense sense if phonological representations affect processing before semantic
ones.)

This plot suggests an important finding: Children becoming more sensitive to the
phonological and semantic foils as they grow older. (I use the verb *suggest*
because this is still a preliminary, unmodeled finding.) Jan and I had made
opposite predictions about whether this would happen. Her argument, I think, was
that children become better at word recognition by becoming better able to
inhibit interference from competing words. This plot would suggest that they
show increased sensitive to the target and foils words by looking less to the
unrelated word as they age and reapportioning those looks to the other three
lexically relevant words.






## Comparing strong versus weak foils

In @RWLPaper, we ignored trials for certain items where we didn't think the
phonological or semantic similarity was strong enough. The two sets of
phonological foils are shown below.

```{r print-phon-foil-tables, message = FALSE, echo = FALSE}
trial_info <- bind_rows(
  readr::read_csv("data-raw/rwl_timepoint1_trials.csv.gz"),
  readr::read_csv("data-raw/rwl_timepoint2_trials.csv.gz"),
  readr::read_csv("data-raw/rwl_timepoint3_trials.csv.gz")) %>% 
  select(
    TrialID, Target = WordTarget, PhonologicalFoil = WordPhonologicalFoil,
    SemanticFoil = WordSemanticFoil, 
    Unrelated = WordUnrelated)

good_phono <- c("bear", "bee", "bell", "dress", "drum", "flag", "fly", 
                "heart", "horse", "pan", "pear", "pen", "vase")

good_semy <- c("bear", "bee", "bell", "bread", "cheese", "dress", 
               "drum", "fly", "horse", "pan", "pear", "shirt", "spoon")

words <- trial_info %>% 
  distinct(Target, PhonologicalFoil, SemanticFoil, Unrelated)

phono_foils <- split(words, words$Target %in% good_phono) %>% 
  lapply(arrange, Target) %>% 
  setNames(c("weak_foil", "strong_foil"))

semy_foils <- split(words, words$Target %in% good_semy) %>% 
  lapply(arrange, Target) %>% 
  setNames(c("weak_foil", "strong_foil"))

phono_foils$strong_foil %>% 
  knitr::kable(caption = "Trials with strong phonological foils.")

phono_foils$weak_foil %>% 
  knitr::kable(caption = "Trials with weak phonological foils.")
```

The stronger phonological foils are pairs where the syllable onsets are the
same. The weaker foils include rime pairs, pairs where the words have
different syllable onsets, and pairs where the onsets differ by a phonetic
feature.

```{r print-semy-foil-tables, message = FALSE, echo = FALSE}
semy_foils$strong_foil %>% 
  knitr::kable(caption = "Trials with strong semantic foils.")

semy_foils$weak_foil %>% 
  knitr::kable(caption = "Trials with weak semantic foils.")
```

The strong semantic foils belong to the same category and the weaker ones have a
less obvious relationship (*ring* and *dress*).

We visually confirm that the strong versus weak foils behave differently.

```{r by-aoi-logit-foils, out.width = "100%", fig.height = 2.5, fig.width = 6, echo = FALSE, message = FALSE}
weak_phon_looks <- trial_info %>% 
  semi_join(phono_foils$weak_foil) %>% 
  inner_join(data) %>% 
  mutate(PhonFoil = "Weak")

strong_phon_looks <- trial_info %>% 
  semi_join(phono_foils$strong_foil) %>% 
  inner_join(data) %>% 
  mutate(PhonFoil = "Strong")

phon_data <- bind_rows(strong_phon_looks, weak_phon_looks)

weak_semy_looks <- trial_info %>% 
  semi_join(semy_foils$weak_foil) %>% 
  inner_join(data) %>% 
  mutate(SemyFoil = "Weak")

strong_semy_looks <- trial_info %>% 
  semi_join(semy_foils$strong_foil) %>% 
  inner_join(data) %>% 
  mutate(SemyFoil = "Strong")

phon_data <- bind_rows(strong_phon_looks, weak_phon_looks)
semy_data <- bind_rows(weak_semy_looks, strong_semy_looks)

looks_by_aoi2 <- phon_data %>% 
  aggregate_looks(
    phon_defs, 
    Study + ResearchID + PhonFoil + Time ~ GazeByImageAOI) %>% 
  rename(AOI = .response_def) %>% 
  select(AOI:Time, PhonFoil, Prop, Primary, PhonologicalFoil, Unrelated) %>% 
  mutate(
    AOI = factor(
      AOI, c("Target", "PhonologicalFoil", "SemanticFoil", "Unrelated")))

looks_by_aoi3 <- semy_data %>% 
  aggregate_looks(
    semy_defs, Study + ResearchID + SemyFoil + Time ~ GazeByImageAOI) %>% 
  rename(AOI = .response_def) %>% 
  select(AOI:Time, SemyFoil, Prop, Primary, SemanticFoil, Unrelated) %>% 
  mutate(
    AOI = factor(
      AOI, c("Target", "PhonologicalFoil", "SemanticFoil", "Unrelated")))

ggplot(looks_by_aoi2 %>% filter(AOI != "Unrelated")) + 
  aes(
    x = Time, y = log(Primary / Unrelated), 
    color = Study, linetype = PhonFoil) + 
  geom_hline(size = 2, color = "white", yintercept = 0) +
  stat_smooth() + 
  facet_grid( ~ AOI) + 
  labs(
    x = "Time after target onset [ms]",
    y = "Log odds looking to word vs. unrelated word",
    caption = "GAM smooth on partially screened data") +
  theme_grey(base_size = 9) 

ggplot(looks_by_aoi3 %>% filter(AOI != "Unrelated")) + 
  aes(
    x = Time, y = log(Primary / Unrelated), 
    color = Study, linetype = SemyFoil) + 
  geom_hline(size = 2, color = "white", yintercept = 0) +
  stat_smooth() + 
  facet_grid( ~ AOI) + 
  labs(
    x = "Time after target onset [ms]",
    y = "Log odds looking to word vs. unrelated word",
    caption = "GAM smooth on partially screened data") +
  theme_grey(base_size = 9) 
```

What's going on here:

- The weak phonological foils are indeed weaker than the strong foils.
- The strong semantic foils appear stronger than the weak ones. The strong
  foils show a growth curve pattern of increasing looks away from baseline and
  there a developmental difference among the growth curves for each time
  point.
- Children have a lower advantage for the target (vs unrelated) in weak foil
  trials because... why? My reading is that if the semantic or phonological
  foil is effective, children will look at it instead of the unrelated image.
  Conversely, if the semantic or phonological foil are less effective,
  children will look more to the unrelated image, which pulls down the ratio
  of looks to target versus the unrelated image.

In the above plots, we fixed the denominator to be the number of looks to the
unrelated image and varied the numerator. In the plots below, we fix the
numerator to be the looks to the target and vary the denominator to looks to
target versus looks to each foil.

```{r by-aoi-logit-target-phon, out.width = "100%", fig.height=2.5, fig.width=6, echo = FALSE, message = FALSE}
semantic_target_curves <- looks_by_aoi3 %>% 
  filter(AOI == "Target") %>% 
  mutate(
    `Target vs Semantic` = log(Primary / SemanticFoil), 
    `Target vs Unrelated` = log(Primary / Unrelated)) %>% 
  tidyr::gather(
    "Comparison", "LogOdds", 
    `Target vs Semantic`, `Target vs Unrelated`) 
  
phonological_target_curves <- looks_by_aoi2 %>% 
  filter(AOI == "Target") %>% 
  mutate(
    `Target vs Phonological` = log(Primary / PhonologicalFoil), 
    `Target vs Unrelated` = log(Primary / Unrelated)) %>% 
  tidyr::gather(
    "Comparison", "LogOdds", 
    `Target vs Phonological`, `Target vs Unrelated`) 
  
ggplot(phonological_target_curves) + 
  aes(x = Time, y = LogOdds, color = Study, linetype = PhonFoil) + 
  geom_hline(size = 2, color = "white", yintercept = 0) +
  stat_smooth() + 
  facet_grid( ~ Comparison) + 
  labs(
    x = "Time after target onset [ms]",
    y = "Log odds looking",
    caption = "GAM smooth on partially screened data") +
  theme_grey(base_size = 9) 
```

Curves in both panels attain the same height, so phonological and unrelated foils 
affect processing equally later in the trial. The strong phonological foils 
curves in the Target vs Phonological comparison rise later than the weak foils, 
reflecting early looks to the phonological foils.

```{r by-aoi-logit-target-semi, out.width = "100%", fig.height=2.5, fig.width=6, echo = FALSE, message = FALSE}
ggplot(semantic_target_curves) + 
  aes(x = Time, y = LogOdds, color = Study, linetype = SemyFoil) + 
  geom_hline(size = 2, color = "white", yintercept = 0) +
  stat_smooth() + 
  facet_grid( ~ Comparison) + 
  labs(
    x = "Time after target onset [ms]",
    y = "Log odds looking",
    caption = "GAM smooth on partially screened data") +
  theme_grey(base_size = 9) 
```

Curves in the two panels do not attain the same height, so the semantic foil
reduces odds of fixating to the target later on in a trial. There appears to be
no difference in strong and weak foils in Year 2 and Year 3, so I might be able
to collapse to remove this distinction and include more items in the analysis.


## Preparing data for the model

```{r, echo = FALSE}
opts_model <- list(
  bin_width = 3,
  start_time = 250,
  end_time = 1500
)
opts_model$bin_length <- round(opts_model$bin_width * 16.67, -1)
message("Modelling options: ")
message(str(opts_model))
```

As in the earlier models, we downsampled the data into
`r opts_model$bin_length`-ms (`r opts_model$bin_width`-frame) bins in order to
smooth the data. We modeled the looks from `r opts_model$start_time` to
`r opts_model$end_time` ms. Lastly, we aggregated looks by child, study and
time, and created orthogonal polynomials to use as time features for the model


```{r, echo = FALSE, message = FALSE}
data <- strong_phon_looks %>% 
  select(Study, ResearchID, TrialID:GazeByImageAOI) %>% 
  assign_bins(bin_width = opts_model$bin_width, Time, TrialID)

# Compute time at center of each bin
bin_times <- data %>% 
  distinct(Time, .bin) %>% 
  group_by(.bin) %>% 
  mutate(BinTime = round(median(Time), -1)) %>% 
  ungroup()

# Attach bin times
binned <- data %>% 
  left_join(bin_times, by = c("Time", ".bin")) %>% 
  ungroup() %>% 
  select(-Time) %>% 
  rename(Time = BinTime) 

d <- binned %>% 
  aggregate_looks(phon_defs, Study + ResearchID + Time ~ GazeByImageAOI)

phon_d <- d %>% 
  filter(
    opts_model$start_time <= Time, 
    Time <= opts_model$end_time) %>% 
  polypoly::poly_add_columns(
    Time, degree = 3, scale_width = 1, prefix = "ot") %>% 
  rename(Focus = .response_def)

# phon_d %>%
#   sample_n_of(9, ResearchID) %>%
#   ggplot() +
#     aes(
#       x = Time, y = log(Primary / Unrelated), 
#       color = Study, linetype = Focus) +
#     geom_line(aes(group = interaction(Study, Focus))) +
#     facet_wrap("ResearchID")


```

The final model should looks like this. I'll have to run this for a few days.

```{r, eval = FALSE}
# phon_d <- phon_d %>% 
#   filter(Focus == "PhonologicalFoil")
# 
# library(rstanarm)
# options(mc.cores = parallel::detectCores())
# 
# m <- stan_glmer(
#  cbind(Primary, Unrelated) ~ 
#         Study * (ot1 + ot2 + ot3) + 
#         (ot1 + ot2 + ot3 | ResearchID) + 
#         (ot1 + ot2 + ot3 | Study:ResearchID),
#   family = binomial,
#   prior = normal(0, 1, autoscale = FALSE),
#   prior_intercept = normal(0, 2),
#   prior_covariance = decov(2, 1, 1),
#   control = list(adapt_delta = .99),
#   data = phon_d)
# readr::write_rds(m, "./data/stan_aim1_phon_model2.rds.gz")
```

For this model structure, we estimate two growth curves simultaneously for each
year of the study. Each growth curve is the log-odds of fixating on a certain
image relative to the unrelated image. We use an indicator variable *focus* to
record whether the image is the target or the phonological foil. 

Actually, I am not sure I need to estimate two growth curves simulataneously
yet. I could just estimate log-odds of looking to Phonological vs Unrelated
directly. This would let me estimate year over year changes, the time course of
the effects and maybe some individual differences in looks to the phonological
foil. I could posterior-predict looks at each time bin and see how the 
intervals compare to zero.


Hmmm, this is not working quite right yet.

```{r, eval = FALSE, echo = FALSE}
# library(rstanarm)
# okay <- readr::read_rds("./data/stan_aim1_phon_model2.rds.gz")
# summary(okay, pars = names(fixef(okay)))
# 
# sims <- rstanarm::posterior_predict(okay, draws = 200, seed = "09272017")
# n_trials <- data_frame(y_id = seq_along(okay$y[, 1]), n_trials = rowSums(okay$y))
# 
# length(phon_d$Study)
# length(okay$y[, 1])
# 
# bayesplot:::ppc_data(okay$y[, 1], sims, group = phon_d$Study) %>% 
#   left_join(n_trials, by = "y_id") %>% 
#   mutate(prop = value / n_trials) %>% 
#   ggplot() +
#     aes(x = prop) +
#     stat_density(
#       aes_(group = ~ rep_id),
#       data = function(x) dplyr::filter(x, !.data$is_y),
#       geom = "line", position = "identity", size = .25, alpha = .1, 
#       color = "#0074D9") +
#     stat_density(
#       data = function(x) dplyr::filter(x, .data$is_y),
#       geom = "line", position = "identity", size = 1) + 
#     labs(x = "Proportion of looks", 
#          title = "Observed data and 200 posterior simulations") + 
#     coord_cartesian(xlim = c(0, 1), expand = FALSE) + 
#     facet_wrap("group")
```


## Looks to the phonological foil

```{r, include = FALSE}
n_phon <- phono_foils$strong_foil$Target %>% unique() %>% length()
n_semy <- semy_foils$strong_foil$Target %>% unique() %>% length()
```

Next, we asked how children's sensitivity to the phonological foils changed over
developmental time. We only examined trials for which the phonological foil and
the noun shared the same syllable onset. For example, this criterion included
trials with *dress*–*drum*, *fly*–*flag*, or *horse*–*heart*, but it excluded
trials *kite*–*gift* (feature difference), *bear*–*bread* (onset difference),
and *ring*–*swing* (rimes). We kept `r n_phon` of the 24 trials.

The outcome measure for these analyses was the log-odds of fixating on the
phonological foil versus the unrelated image. Because children looked more to
the target word with each year of the study, they necessarily looked less to the
distractors each year. Figure N below illustrates how the proportions of looks
to the phonological foils declined each year. Therefore, we examined the effect
of the phonological foil in comparison to the unrelated foil. For example, on
the trials where the target is *fly*, we study the effect of the phonological
foil *flag* by looking at when and to what to degree the children fixate on
*flag* more than the unrelated image *pen*. If a window of time of shows a
consistent advantage for the phonological foil over the unrelated image, we can
conclude that the children were sensitive to the phonological foil. By studying
the time course of fixations to the phonological foil versus the unrelated
image, we can identify when the phonological foil affected word recognition most
significantly.

```{r declining-phon-props, echo = FALSE, message = FALSE, out.width = "80%", fig.width = 5, fig.height = 3.5}
phon_d %>% 
  mutate(
    Focus = factor(
      Focus, c("Target", "PhonologicalFoil"), 
      c("Target", "Phonological foil")),
    Study = convert_study_to_age(Study)) %>% 
  ggplot() + 
    aes(x = Time, y = Prop, color = Study) + 
    geom_hline(yintercept = .25, color = "white", size = 2) +
    stat_summary(fun.data = mean_se) + 
    facet_wrap("Focus") +
    labs(
      x = "Time after target onset [ms]",
      y = "Proportion looking to image",
      caption = "Mean ± SE") +
    theme_grey() +
    theme(
      legend.position = c(0.95, 0.95), 
      legend.justification = c(1, 1))
```

To account for the sparseness of the data, we used the empirical log-odds (or
empirical logit) transformation [@Barr2008]. This transformation adds .5 to
the looking counts. For example, a time-frame with 4 looks to the phonological
foil and 1 look to the unrelated image has a conventional log-odds of
log(4/1) = 1.39 and empirical log-odds of log(4.5/1.5) = 1.10. This
transformation fills in 0 values, and it dampens the extremeness of some
probabilities that arise in sparse count data. 

```{r, echo = FALSE, message = FALSE, include = FALSE, out.width = "80%", fig.width = 6}
library(mgcv)
library(itsadug)

phon_d <- phon_d %>% 
  mutate(
    S = factor(Study, c("TimePoint2", "TimePoint1", "TimePoint3")),
    R = as.factor(ResearchID),
    SR = interaction(S, R),
    elog = lookr::empirical_logit(PhonologicalFoil, Unrelated))

# Base model with no study effect
b2n <- gam(
  elog ~ s(Time), 
  data = phon_d, 
  method = "REML")
# summary(b2n)

# Include intercepts and smooths for studies
b2 <- gam(
  elog ~ S + s(Time) + s(Time, by = S), 
  data = phon_d, 
  method = "REML")
# summary(b2)

# b2r <- bam(
#   elog ~ S + s(Time) + s(Time, by = S) + s(Time, R, bs = "fs", m = 1, k = 5), 
#   data = phon_d)
# readr::write_rds(b2r, "./data/aim1-phon-random-smooths.rds.gz")
b2r <- readr::read_rds("./data/aim1-phon-random-smooths.rds.gz")
summary(b2r)

plot(b2r, pages = 1)
```

We fit a generalized additive model with fast restricted maximum likelihood
estimation [@Wood2017; @Soskuthy2017 for a tutorial for linguists]. Box 1
provides a brief overview of these models. We fit the models using the R package
`mgcv` [vers. `r packageVersion("mgcv")`; @Wood2017] with support from the
tools in the `itsadug` package [vers. `r packageVersion("itsadug")`;
@itsadug]. 


<div class = "infobox">
**Box 1: The Intuition Behind Generalized Additive Models**.

In these analyses, the outcome of interest is a value that changes over time in
a nonlinear way. We model these time series by building a set of features to
represent time values. In the growth curve analyses of familiar word
recognition, we used a set of polynomial features which expressed time as the
weighted sum of a linear trend, a quadratic trend and cubic trend. That is:

$$
\text{log-odds}(\mathit{looking}) = 
  \alpha + \beta_1 * \textit{Time}^1 +
           \beta_2 * \textit{Time}^2 +
           \beta_3 * \textit{Time}^3
$$

But another way to think about the polynomial terms is as *basis functions*: A
set of features that combine to approximate some nonlinear function of
time. Under this framework, the model can be expressed as:

$$
\text{log-odds}(\mathit{looking}) = 
  \alpha + f(\textit{Time})
$$
  
This is the idea behind generalized additive models and their *smooth terms*.
These smooths fit nonlinear functions of data by weighting and adding 
simple functions together. The figures below show 9 basis functions from a
"thin-plate spline" and how they can be weighted and summed to fit a growth
curve.

```{r infobox-1-figs, message = FALSE, echo = FALSE, out.width = "66%", fig.width = 6, fig.height = 3}
library(mgcv)
library(ggplot2)
library(dplyr)

t1_fam <- structure(
  list(
    Time = c(
      250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 
      950, 1000, 1050, 1100, 1150, 1200, 1250, 1300, 1350, 1400, 1450, 1500), 
    Prop = c(
      0.252, 0.255, 0.257, 0.261, 0.265, 0.275, 0.286, 0.298, 0.311, 0.315, 
      0.329, 0.342, 0.365, 0.392, 0.407, 0.422, 0.446, 0.464, 0.479, 0.497, 
      0.514, 0.524, 0.532, 0.545, 0.549, 0.555)), 
  .Names = c("Time", "Prop"), 
  class = c("tbl_df", "tbl", "data.frame"), 
  row.names = c(NA, -26L))

times <- modelr::seq_range(t1_fam$Time, 80)
newdata <- data.frame(Time = times)
t1_gam <- gam(Prop ~ s(Time), data = t1_fam)

t1_gam <- gam(Prop ~ s(Time, bs = "tp", k = 10), data = t1_fam)
basis_matrix <- predict(t1_gam, newdata, type = "lpmatrix")[, 2:10]

basis <- polypoly::poly_melt(basis_matrix) %>% 
  mutate(observation = as.numeric(observation)) %>% 
  left_join(
    data.frame(Time = times, observation = seq_along(times)), 
    by = "observation")

p1 <- ggplot(basis) + 
  aes(x = Time, y = value) + 
  geom_line(aes(color = degree)) + 
  ylim(c(-2, 2)) + 
  guides(color = FALSE) + 
  ggtitle("Basis functions (time features)") + 
  labs(y = NULL) +
  theme_grey(base_size = 9) + 
  theme(
    plot.background = element_rect(fill = "#eef7fa", colour = "#eef7fa"),
    panel.background = element_rect(fill = "#E5EAEF"))

weighted <- (basis_matrix %*% diag(coef(t1_gam)[-1])) %>% 
  polypoly::poly_melt() %>% 
  mutate(observation = as.numeric(observation)) %>% 
  left_join(
    data.frame(Time = times, observation = seq_along(times)), 
    by = "observation")

p2 <- ggplot(weighted) + 
  aes(x = Time, y = value) + 
  geom_line(aes(color = factor(degree))) + 
  stat_summary(fun.y = sum, color = "#0074D9", geom = "line", size = 1.25) + 
  ylim(c(-.2, .2)) + 
  guides(color = FALSE) + 
  ggtitle("Weighted basis functions") + 
  labs(y = NULL) +
  theme_grey(base_size = 9)  + 
  theme(
    plot.background = element_rect(fill = "#eef7fa", colour = "#eef7fa"),
    panel.background = element_rect(fill = "#E5EAEF"))

p3 <- cowplot::plot_grid(p1, p2)
print(p3)
# ggsave("./misc/basis-raw.png", p1,  width = 3, height = 3)
# ggsave("./misc/basis-weighted.png", p2, width = 3, height = 3)
# cowplot::ggsave("./misc/basis-both.png", p3, width = 6, height = 3)
```

Each of these basis functions is weighted by a model coefficient, but the
individual basis functions are not a priori meaningful. Rather, it is the whole
set of functions that approximate the curvature of the data---i.e.,
*f*(Time))---so we statistically evaluate the whole batch of coefficients
simultaneously. This joint testing is similar to how one might test a batch of
effects in an ANOVA. If the batch of effects jointly improve model fit, we infer
that there is a significant smooth or shape effect. (Not quite sure this is 100%
accurate yet.)

<!-- The other important thing to know about generalized additive models is that -->
<!-- wigglyness is penalized. With so many functions, one might worry about -->
<!-- overfitting the data and including incidental wiggliness into *f*(Time). These -->
<!-- models, however, include a smoothing parameter that -->
</div>


The model included main effects of study year. These *parametric* terms
work like conventional regression effects and determined the growth curve's
average values. We used age 4 as the reference year, so the model's intercept
represented the average looking probability at age 4. The model's year effects
therefore represented differences between age 4 vs. age 3 and age 4 vs. age 5.

The model also included *smooth* terms to represent the time course of the data.
We included a smooth term for trial time to represent a general effect of time
following noun onset across all studies, and we also included smooth terms for
time for each study. These study-specific smooths estimate how the shape of the
data differs in each individual study. Each of these smooths used 10 knots (9
basis functions). We also included child-level "random smooths" to represent
child-level variation in growth curve shapes. Because we have much as less data
at the child level than at the study level, these random smooths only included 5
knots (4 basis functions). We can think of these simpler splines as coarse
adjustments in growth curve shape to capture child-level variation from limited
data. Altogether, the estiamte model contain the following terms:

```
emp. log-odds(phonological vs. unrelated) = 
  α + β1*Study1 + β2*Study3 +   [growth curve averages]
  f1(Time) +                    [general smooth]
  f2(Time, Age-3) +             [study-specific smooths]
  f3(Time, Age-4) + 
  f4(Time, Age-5) + 
  f5(Time, Child-ID)            [by-child random smooths]
```

```{r, echo = FALSE}
coef(summary(b2r))


anova(b2r) %>% getElement("s.table") %>% as.data.frame()

para <- broom::tidy(b2r, parametric = TRUE) 

tp2 <- para %>% 
  filter(term == "(Intercept)") %>% 
  pull(estimate) %>% 
  printy::fmt_fix_digits(2)

tp2_prop <- para %>% 
  filter(term == "(Intercept)") %>% 
  pull(estimate) %>% 
  plogis() %>% 
  printy::fmt_fix_digits(2) %>% 
  printy::fmt_leading_zero() 

tp1_p <- para %>% 
  filter(term == "STimePoint1") %>% 
  pull(p.value) %>% 
  printy::fmt_p_value(digits = 2)

tp2_est <- para %>% 
  filter(term == "(Intercept)") %>% 
  pull(estimate) 

tp3_est <- para %>% 
  filter(term == "STimePoint3") %>% 
  pull(estimate) 

tp3_prop <- (tp2_est + tp3_est) %>% 
  plogis() %>% 
  printy::fmt_fix_digits(2) %>% 
  printy::fmt_leading_zero() 

tp3 <- (tp2_est + tp3_est) %>% 
  printy::fmt_fix_digits(2)

tp3_p <- para %>% 
  filter(term == "STimePoint3") %>% 
  pull(p.value) %>% 
  printy::fmt_p_value()
```

The model’s fitted values are shown in Figure N. These are the average empirical
log-odds of fixating on the phonological foil versus the unrelated image for
each year of the study. The model captured the trend for increased looks to the
competitor image with each year of the study. At age 4 and age 5, the shape
rises from a baseline to the peak around 800 ms. These curves slope downwards
and eventually fall beneath the initial baseline. The shape at age 3 does not
have a steady rise from baseline and shows a very small peak around 800 ms.

```{r phon-vs-unre-fits, echo = FALSE, warning = FALSE, message = FALSE, out.width = "80%", fig.width = 5, fig.height = 4, results = "hide"}
b2r %>% 
  get_predictions(
    cond = list(
      Time = unique(phon_d$Time), 
      S = unique(phon_d$S)),
    rm.ranef = TRUE) %>% 
  left_join(recode_studies) %>% 
  ggplot() + 
    aes(x = Time, y = fit, fill = Age) + 
    geom_hline(size = 2, yintercept = 0, color = "white") +
    geom_ribbon(aes(ymin = fit - CI, ymax = fit + CI), alpha = .2) +
    geom_line(aes(color = Age), size = 1) + 
    labs(
      color = "Study",
      fill = "Study",
      x = "Time after target onset [ms]",
      y = "Emp. log-odds(Phon. vs. Unrelated)",
      caption = "Fitted values with 95% interval") + 
    theme(
    legend.position = c(0.95, 0.95), 
    legend.justification = c(1, 1))
```

The average looks to the phonological foil over the unrelated for age 4 was
`r tp2` emp. log-odds, `r tp2_prop` proportion units. The averages for age 3 and
age 4 did not significantly differ, *p* = `r tp1_p` but the average value was
significantly greater at age 5, `r tp3` emp. log-odds, `r tp3_prop` proportion
units, *p* `r tp1_p`. Visually, this effect shows up in the almost constant
height difference between the age-4 and the age-5 curves.

```{r}
summary()
smooth <- broom::tidy.gam(b2r) 
```


There was a significant smooth term for time in general, (f-test stats) and for
the age-3 smooth, (f-test stats). In contrast, the age-4 and age-5 smooths did
not differ significantly from the general time smooth, (p\_age-4 = ), (p\_age-5
= ). The shapes of the age-4 and age-5 growth curves showed the same general
shape but with different heights.

[kinda rough here] We also computed the difference between the growth curves from
successive studies. These are shown in Figure N. The curves of the age-3 and age-4 were 
significantly different from 500 to 1050 ms. This result confirms that the looks
to the phonological foil increased from timepoint 1 and timepoint 2 in the time
window immediately following presentation of the noun. The two curves also
differed significantly after 1250 ms. The effect reflects how the looks to
phonological foil decreased as the trial progresses. The similarity between the
phonological foil and the target occurs early in the trial, so we observed
increased looks to the phonological foil early in the trial. After an incorrect
look to the foil, the children on average correct their gaze and look even less
to the phonological foil. We do not observe this degree of correction during
timepoint 1 because children hardly looked to the phonological foil early on.

```{r phon-diff-curves, echo = FALSE, message = FALSE, out.width = "80%", fig.width = 5, fig.height = 3, results = "hide"}
age5_age4 <- b2r %>% 
  get_difference(
    comp = list(S = c("TimePoint3", "TimePoint2")), 
    cond = list(Time = unique(phon_d$Time)), 
    rm.ranef = TRUE) %>% 
  mutate(comparison = "Age 5 − Age 4")
  
age4_age3 <- b2r %>% 
  get_difference(
    comp = list(S = c("TimePoint2", "TimePoint1")), 
    cond = list(Time = unique(phon_d$Time)), 
    rm.ranef = TRUE) %>% 
  mutate(comparison = "Age 4 − Age 3")  

rle_lengths <- function(xs) rle(xs)[["lengths"]]

differences <- bind_rows(age5_age4, age4_age3) %>% 
  rename(fit = difference) %>% 
  mutate(
    upper = fit + CI, 
    lower = fit - CI,
    no_zero = 0 > upper | 0 < lower) %>% 
  group_by(comparison) %>% 
  arrange(comparison, Time) %>% 
  mutate(
    streak = rep(seq_along(rle_lengths(no_zero)), rle_lengths(no_zero))) %>% 
  ungroup()

sig_regions <- differences %>% 
  filter(no_zero) %>% 
  group_by(comparison, streak) %>% 
  summarize(min = min(Time), max = max(Time)) %>% 
  ungroup()

ggplot(differences) + 
  aes(x = Time, y = fit) + 
  geom_hline(size = 2, yintercept = 0, color = "white") +
  geom_vline(
    aes(xintercept = min), data = sig_regions, 
    color = "blue", alpha = .5, linetype = "dashed") +
  geom_vline(
    aes(xintercept = max), data = sig_regions, 
    color = "blue", alpha = .5, linetype = "dashed") +
  geom_segment(
      aes(x = min, xend = max, group = streak), y = -Inf, yend = -Inf,
      data = sig_regions, color = "blue",  alpha = .5, size = 1) + 
  geom_segment(
      aes(x = min, xend = max, group = streak), y = Inf, yend = Inf,
      data = sig_regions, color = "blue",  alpha = .5, size = 1.1) + 
  geom_ribbon(aes(ymin = fit - CI, ymax = fit + CI), alpha = .2) +
  geom_line(size = 1) +
  labs(
      color = "Study",
      fill = "Study",
      x = "Time after target onset [ms]",
      y = "Difference in emp. log-odds",
      caption = "Estimated difference with 95% interval") + 
  facet_wrap("comparison")
```



The difference between the timepoint 2 and the timepoint 3 smooths is driven by
the the intercept difference. The difference line between the two is a straight
line. The two curves start from the same location and slowly diverge. The same
looking behavior is observed for these two studies, but the foil effect is more
pronounced at timepoint 3.



Talking points:

  - Children increased their relative looks to the phonological foil with each
    year of the study. Although they looked to the target more quickly and more
    reliably with each of the study, the advantage of the phonological foil over
    the unrelated image increased with each year. Thus, the children became more
    sensitive to the phonological cohort words as they grew older.
  - There is hardly an effect of the phonological foil during timepoint 1. There
    are a few ways to interpret this finding. The first may be artefactual. The
    stimuli were re-recorded at timepoint 2 so the timepoint 1 stimuli were
    somewhat longer on average (around 800 ms at TP1 vs. 550--800ms later on).
    However, with slower stimuli, we would still expect an inflection in looks
    to the foil as children have more time to activate the phonological
    representations to the cohort. In other words, with more time to respond,
    there could plausibly be an even greater effect of early phonological
    information.
  - Alternatively, the children in timepoint 1 may not be using the early
    similarity of words during word recognition. That is, instead of immediate
    incremental activation of lexical cohorts, the children may not be
    activating the cohorts as reliably. This would imply that further study is
    required on the evidence for when young children begin to show immediate
    activation of cohorts.
  - The children at timepoint1 may not be incrementally activating the cohorts.
    The children in timepoint 2 and 3 certainly are.
  - Incremental activation and early commitments to partial information goes up 
    with age.


Here we have the data and the model fits.

```{r, echo = FALSE, message = FALSE, out.width = "80%", fig.width = 6}
phon_d$fitted_elogit <- predict.gam(b2r)

ggplot(phon_d) +
  aes(x = Time, y = fitted_elogit, color = Study) +
  stat_summary(aes(y = elog)) +
  stat_summary(fun.y = "mean", geom = "line") +
  labs(
    y = "empirical logit",
    caption = "Lines: GAM fit. Point-ranges: Obs. Mean ± SE")
```


```{r, results = "asis"}
itsadug::gamtabs(b2r, type = "html")
```









## Looks to the semantic foil

We used a similiar procedure on the looks to the semantic foil.

```{r}
n_semy <- semy_foils$strong_foil$Target %>% unique() %>% length()
```

Next, we asked how children's sensitivity to the semantic foils changed over
developmental time. We only examined trials for which the semantic foil and the
noun were part of the same category. We kept trials, for example, with
*bee*–*fly*, *shirt*–*dress*, or *spoon*–*pan*, but we excluded trials where
the similarity was perceptual (*sword*–*pen*) or too abstract (*swan*–*bee*). We
kept `r n_semy` of the 24 trials.


```{r, echo = FALSE, message = FALSE, out.width = "80%", fig.width = 6}
semy_data <- strong_semy_looks %>% 
  select(Study, ResearchID, TrialID:GazeByImageAOI) %>% 
  assign_bins(bin_width = opts_model$bin_width, Time, TrialID)

# Compute time at center of each bin
bin_times <- semy_data %>% 
  distinct(Time, .bin) %>% 
  group_by(.bin) %>% 
  mutate(BinTime = round(median(Time), -1)) %>% 
  ungroup()

# Attach bin times
binned <- semy_data %>% 
  left_join(bin_times, by = c("Time", ".bin")) %>% 
  ungroup() %>% 
  select(-Time) %>% 
  rename(Time = BinTime) 

semy_d <- binned %>% 
  aggregate_looks(semy_defs, Study + ResearchID + Time ~ GazeByImageAOI)

semy_d <- semy_d %>% 
  filter(
    250 <= Time,
    Time <= 1800
  ) %>%
  # polypoly::poly_add_columns(
  #   Time, degree = 3, scale_width = 1, prefix = "ot") %>% 
  rename(Focus = .response_def)

semy_d %>%
  sample_n_of(9, ResearchID) %>%
  ggplot() +
    aes(
      x = Time, y = log(Primary / Unrelated), 
      color = Study, linetype = Focus) +
    geom_line(aes(group = interaction(Study, Focus))) +
    facet_wrap("ResearchID")

semy_d <- semy_d %>% 
  mutate(
    S = factor(Study, c("TimePoint2", "TimePoint1", "TimePoint3")),
    R = as.factor(ResearchID),
    SR = interaction(S, R),
    elog = lookr::empirical_logit(SemanticFoil, Unrelated))

# Base model with no study effect
s2n <- gam(
  elog ~ s(Time), 
  data = semy_d, 
  method = "REML")
# summary(b2n)

# Include intercepts and smooths for studies
s2 <- gam(
  elog ~ S + s(Time) + s(Time, by = S), 
  data = semy_d, 
  method = "REML")
summary(s2)
plot(s2, pages = 1)
# gam.check(s2)
# anova(b2n, b2)

AIC(s2n, s2)
```

The model’s predictions are shown in the figure. It captured the trend for
increased looks to the competitor image with each year of the study.

```{r, echo = FALSE, message = FALSE, out.width = "80%", fig.width = 5}
itsadug::plot_smooth(s2, view = "Time", plot_all = "S")
```

We also computed the difference of the curves from different studies. The
difference from timepoint 1 to timepoint 2 is just a matter of height.

```{r, echo = FALSE, message = FALSE, out.width = "80%", fig.width = 5}
itsadug::plot_diff(
  s2,
  view = "Time",
  comp = list(S = c("TimePoint2", "TimePoint1")))
```

The difference from timepoint 2 to timepoint 3 includes a slight bump as the two
curves diverge from a similar starting position.

```{r, echo = FALSE, message = FALSE, out.width = "80%", fig.width = 4}
itsadug::plot_diff(
  s2,
  view = "Time",
  comp = list(S = c("TimePoint3", "TimePoint2")))
```

Timepoint 3 and timepoint 1 differ too. 

```{r, echo = FALSE, message = FALSE, out.width = "80%", fig.width = 5}
itsadug::plot_diff(
  s2,
  view = "Time",
  comp = list(S = c("TimePoint3", "TimePoint1")))
```

Here we have the data and the model fits.

```{r, echo = FALSE, message = FALSE, out.width = "80%", fig.width = 4}
semy_d$fitted_elogit <- predict.gam(s2)

ggplot(semy_d) +
  aes(x = Time, y = fitted_elogit, color = Study) +
  stat_summary(aes(y = elog)) +
  stat_summary(fun.y = "mean", geom = "line") +
  labs(
    y = "empirical logit",
    caption = "Lines: GAM fit. Point-ranges: Obs. Mean ± SE")
```







```{r, results = "asis"}
itsadug::gamtabs(s2, type = "html")
```








## Look for individual differences in competitor sensitivity

[...put this on hold for a while...]

<!-- Let's just run with all the foils. There's a trade-off here about sparsity and -->
<!-- strength of the stimuli. -->

```{r, eval = TRUE, out.width = "100%", echo = FALSE}
# ggplot(phon_d %>% filter(Focus == "PhonologicalFoil")) + 
#   aes(x = Time, y = empirical_logit(PhonologicalFoil, Unrelated)) + 
#   geom_line(aes(group = ResearchID), alpha = .2) + 
#   stat_smooth() +
#   facet_grid(. ~ Study)
# 
# ggplot(phon_d %>% filter(Focus == "PhonologicalFoil")) + 
#   aes(x = Time, y = empirical_logit(PhonologicalFoil, Unrelated)) + 
#   geom_line(aes(group = interaction(ResearchID, Study)), alpha = .2) + 
#   stat_smooth(aes(color = Study)) 
# 
# phon_d %>%
#   filter(Focus == "PhonologicalFoil") %>% 
#   sample_n_of(9, ResearchID) %>%
#   ggplot() + 
#     aes(x = Time, y = empirical_logit(PhonologicalFoil, Unrelated)) + 
#     geom_line(aes(group = interaction(ResearchID, Study)), alpha = .2) + 
#     stat_smooth(aes(color = Study)) +
#   facet_wrap("ResearchID")
# 
minp1 <- readr::read_csv("./data-raw/test_scores.csv") %>% 
  select(Study, ResearchID, MinPair_ProportionCorrect) %>% 
  filter(Study == "TimePoint1") %>% 
  mutate(
    MinP = ntile(MinPair_ProportionCorrect, 4),
    Cut = cut(MinPair_ProportionCorrect, c(0, .6, .8, 1))) %>% 
  select(-Study)

# table(minp1$Cut)
 
phon_d %>% 
  filter(Focus == "PhonologicalFoil") %>% 
  left_join(minp1) %>% 
  ggplot() + 
    aes(x = Time, y = plogis(empirical_logit(PhonologicalFoil, Unrelated))) + 
    geom_line(aes(group = ResearchID), alpha = .2) +
    stat_smooth(aes(color = Cut), se = FALSE) +
    facet_grid(. ~ Study)  + 
    ggtitle("To phon foil by minimal pairs")

phon_d %>% 
  filter(Focus == "Target") %>% 
  left_join(minp1) %>% 
  ggplot() + 
    aes(x = Time, y = Prop) + 
    geom_line(aes(group = ResearchID), alpha = .2) +
    stat_smooth(aes(color = Cut), se = FALSE) +
    facet_grid(. ~ Study) + 
   ggtitle("Prop to target by minimal pairs")

# phon_d %>% 
#   filter(Focus == "Target") %>% 
#   left_join(minp1) %>% 
#   ggplot() + 
#     aes(x = Time, y = plogis(empirical_logit(Target, Unrelated))) + 
#     geom_line(aes(group = ResearchID), alpha = .2) +
#     stat_smooth(aes(color = Cut), se = FALSE) +
#     facet_grid(. ~ Study)

# phon_d %>% 
#   filter(Focus == "PhonologicalFoil") %>% 
#   left_join(minp1) %>% 
#   ggplot() + 
#     aes(x = Time) + 
#     # geom_line(aes(group = ResearchID), alpha = .2) +
#     stat_smooth(
#       aes(color = Cut, y = plogis(empirical_logit(Target, PhonologicalFoil))), 
#       se = FALSE) +
#     stat_smooth(
#       aes(color = Cut, y = plogis(empirical_logit(Target, Unrelated))), 
#       se = FALSE, linetype = "dashed") +
#     facet_grid(Cut ~ Study)

# phon_d %>% 
#   filter(Focus == "Target") %>% 
#   left_join(minp1) %>% 
#   ggplot() + 
#     aes(x = Time, y = Prop) + 
#     geom_line(aes(group = ResearchID), alpha = .2) +
#     stat_smooth(aes(color = Cut), se = FALSE) +
#     facet_grid(. ~ Study)


evt1 <- readr::read_csv("./data-raw/test_scores.csv") %>% 
  select(Study, ResearchID, EVT_Standard) %>% 
  filter(Study == "TimePoint1") %>% 
  mutate(EVT = ntile(EVT_Standard, 4)) %>% 
  select(-Study)

# gfta1 <- readr::read_csv("./data-raw/scores_for_participant_summary.csv") %>% 
#   select(Study, ResearchID, GFTA_Standard) %>% 
#   filter(Study == "TimePoint1") %>% 
#   mutate(GFTA = ntile(GFTA_Standard, 4)) %>% 
#   select(-Study)


phon_d %>% 
  filter(Focus == "PhonologicalFoil") %>% 
  left_join(evt1) %>% 
  ggplot() + 
    aes(x = Time, y = empirical_logit(PhonologicalFoil, Unrelated)) + 
    geom_line(aes(group = ResearchID), alpha = .2) + 
    stat_smooth(aes(color = factor(EVT)), se = FALSE) +
    facet_grid(. ~ Study)

# phon_d %>% 
#   filter(Focus == "PhonologicalFoil") %>% 
#   left_join(gfta1) %>% 
#   ggplot() + 
#     aes(x = Time, y = empirical_logit(PhonologicalFoil, Unrelated)) + 
#     geom_line(aes(group = ResearchID), alpha = .2) + 
#     stat_smooth(aes(color = factor(GFTA)), se = FALSE) +
#     facet_grid(. ~ Study)



semy_d %>% 
  filter(Focus == "SemanticFoil") %>% 
  left_join(evt1) %>% 
  ggplot() + 
    aes(x = Time, y = empirical_logit(SemanticFoil, Unrelated)) + 
    geom_line(aes(group = ResearchID), alpha = .2) + 
    stat_smooth(aes(color = factor(EVT)), se = FALSE) +
    facet_grid(. ~ Study)

semy_d %>% 
  filter(Focus == "SemanticFoil") %>% 
  left_join(minp1) %>% 
  ggplot() + 
    aes(x = Time, y = empirical_logit(SemanticFoil, Unrelated)) + 
    geom_line(aes(group = ResearchID), alpha = .2) + 
    stat_smooth(aes(color = Cut), se = FALSE) +
    facet_grid(. ~ Study)

# m <- glmer(
#   cbind(PhonologicalFoil, Unrelated) ~ 
#     (ot1 + ot2 + ot3) * Study + 
#     (ot1 + ot2 + ot3 | ResearchID), 
#   family = binomial,
#   data = d_m)
# summary(m)
```

```{r, eval = FALSE, echo = FALSE}
library(lme4)
fx <- . %>% 
  glmer(
    cbind(PhonologicalFoil, Unrelated) ~
      (ot1 + ot2 + ot3) +
      (ot1 + ot2 + ot3 | ResearchID),
    family = binomial,
    data = .)

by_study <- d_m %>% 
  tidyr::nest(-Study) %>% 
  mutate(model = purrr::map(data, fx))


lapply(by_study$model, summary)

by_study <- by_study %>% 
  mutate(data = purrr::map2(model, data, broom::augment))



data
size = 10
tidyr::unnest(by_study, data) %>% 
  sample_n_of(12, ResearchID) %>% 
  ggplot() + 
  aes(x = BinTime, y = .fitted, color = Study) + 
  geom_point() + 
  geom_line(aes(group = interaction(ResearchID, Study))) + 
  facet_wrap("ResearchID")
```

## Interim summary

* Visual evidence that the semantic foil and phonological foil become more 
  relevant (compared to unrelated foil) each year. 
* Our previous distinction between strong and weak foils still applies, 
  although it might be better to exclude only the (a priori) weakest foils, 
  like the rime phonological foils.

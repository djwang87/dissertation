# Analyze familiar word recognition

Next steps:

- Model year over year changes.
- Download test scores and individual differences. 
- Analyze individual differences

```{r include = FALSE}
knitr::read_chunk("./helpers.R")
if (interactive()) source("./helpers.R")
```

```{r helpers, message = FALSE, warnings = FALSE}
```

## Data preparation

Earlier we cleaned the data to remove trials with excessive missing data 
and blocks of trials with too few trials. Read in that data.

```{r, message = FALSE, warnings = FALSE}
data <- readr::read_csv("./data/aim1-screened.csv.gz")
```

Downsample into 50 ms bins.

```{r, eval = TRUE}
data <- data %>% 
  select(Study, ResearchID, TrialID:GazeByImageAOI) %>% 
  assign_bins(bin_width = 3, Time, TrialID)

# Compute time at center of each bin
bin_times <- data %>% 
  distinct(Time, .bin) %>% 
  group_by(.bin) %>% 
  mutate(BinTime = round(median(Time), -1)) %>% 
  ungroup()

# Attach bin times
binned <- data %>% 
  left_join(bin_times, by = c("Time", ".bin")) %>% 
  ungroup() %>% 
  select(-Time) %>% 
  rename(Time = BinTime) 

resp_def <- create_response_def(
  primary = "Target",
  others = c("PhonologicalFoil", "SemanticFoil", "Unrelated"),
  elsewhere = "tracked",
  missing = NA
)  
  
d <- binned %>% 
  aggregate_looks(resp_def, Study + ResearchID + Time ~ GazeByImageAOI)

d_m <- d %>% 
  filter(250 <= Time, Time <= 1500) %>% 
  polypoly::poly_add_columns(Time, degree = 3, 
                             scale_width = 1, prefix = "ot")
```

Plot the model-ready data. Use empirical logit because straight log-odds has too
high of values for plotting.

```{r spaghetti-elogit, out.width = "100%", fig.height=2.5, fig.width=6}
ggplot(d_m) + 
  aes(x = Time, y = empirical_logit(Primary, Others)) + 
  geom_line(aes(group = ResearchID), alpha = .2) + 
  stat_smooth() +
  theme_grey(base_size = 9) +
  facet_grid(. ~ Study) + 
  labs(x = "Time after target onset (smoothed to 50 ms bins)", 
       y = "Emp. logit looking to target")
```

## Maximum likelihood results

Fit a maximum likelihood model as a first pass for the analysis. We won't fit
the model automatically (whenever this page is updated). It's too time
consuming. Instead, we do it manually here, and save the results.

```{r, eval = FALSE}
library(lme4)
m <- glmer(
    cbind(Primary, Others) ~
      (ot1 + ot2 + ot3) * Study +
      (ot1 + ot2 + ot3 | ResearchID/Study),
    family = binomial,
    data = d_m)
readr::write_rds(m, "./data/aim1_cubic_model.rds.gz")
```

And reload the saved model here.

```{r cubic-model-fits, out.width = "100%", fig.height=2.5, fig.width=6}
library(lme4)
m <- readr::read_rds("./data/aim1_cubic_model.rds.gz")
arm::display(m)

# f1 <- function(data) {
#   glmer(
#     cbind(Primary, Others) ~
#       (ot1 + ot2 + ot3) +
#       (ot1 + ot2 + ot3 | ResearchID),
#     family = binomial,
#     data = data)
# }
# 
# separate_studies <- d_m %>% 
#   tidyr::nest(-Study) %>% 
#   mutate(model = purrr::map(data, f1))

d_m$cubic_fit <- fitted(m)

ggplot(d_m) + 
  aes(x = Time, y = cubic_fit) + 
  geom_line(aes(group = ResearchID), alpha = .2) + 
  stat_smooth(method = "gam") +
  facet_grid(. ~ Study) + 
    labs(
      x = "Time after target onset (smoothed to 50 ms bins)",
      y = "Proportion looks to target (fitted)") +
  theme_grey(base_size = 9) 
```

What's being captured by the random effects?

```{r cubic-model-fits-ranefs, out.width = "100%", fig.height=2.5, fig.width=6}
predict_y <- function(...) predict(..., type = "response")
d_m$subj_fit <- predict_y(m, re.form = ~ (ot1 + ot2 + ot3 | ResearchID))

ggplot(d_m) + 
  aes(x = Time, y = subj_fit) + 
  geom_line(aes(group = ResearchID), alpha = .2) + 
  facet_grid(. ~ Study) + 
  theme_grey(base_size = 9) +
  labs(
    x = "Time after target onset (smoothed to 50 ms bins)",
    y = "Proportion looks to target (fitted)",
    caption = "Conditioned on Child effects") 

# d_m$study_fit <- predict_y(m, re.form = ~ (ot1 + ot2 + ot3 | Study:ResearchID))
# ggplot(d_m) + 
#   aes(x = Time, y = study_fit) + 
#   geom_line(aes(group = ResearchID), alpha = .2) + 
#   facet_grid(. ~ Study) + 
#   theme_grey(base_size = 9) +
#   labs(
#     x = "Time after target onset (smoothed to 50 ms bins)",
#     y = "Proportion looks to target (fitted)",
#     caption = "Conditioned on Study x Child effects") 
```



```{r cubic-model-raw-fit-corr, out.width = "50%", fig.height=3, fig.width=4}
d_corr <- d_m %>% 
  group_by(Time, Study) %>% 
  summarise(r = cor(Prop, cubic_fit)) 

ggplot(d_corr) + 
  aes(x = Time, y = r, color = Study) + 
  geom_point(shape = 1, size = 3) + 
  ylim(c(.8, 1)) + 
  labs(
    x = "Time after target onset (smoothed to 50 ms bins)",
    y = "Correlation of fitted and observed") + 
  theme_grey(base_size = 9) +
  theme(
    legend.position = c(0.025, 0.05), 
    legend.justification = c(0, 0)) 

  
# ggplot(d_m) + 
#   aes(x = Prop, y = cubic_fit) + 
#   geom_point(shape = 1, alpha = .2) + 
#   geom_abline(color = "blue", size = 2)
#   geom_line(aes(group = ResearchID), alpha = .2) + 
#   stat_smooth() +
#   facet_grid(. ~ Study) + 
#     labs(y = "Proportion looks to target [model fits]", 
#        x = "Time after target onset (smoothed to 50 ms bins)")


# ggplot(inner_join(d_m, ranks),) + 
#   aes(x = Time, y = cubic_fit, color = -slope) + 
#   geom_line(aes(group = ResearchID), alpha = .4) +
#   viridis::scale_color_viridis() + 
#   facet_grid(. ~ Study)
  # geom_line(aes(group = ResearchID), data = semi_join(d_m, top_10), size = 1, color = "blue") + 
  # geom_line(aes(group = ResearchID), data = semi_join(d_m, bot_10), size = 1, color = "red") +
```


Visualize the top and bottom 20 children (pooled over studies).

```{r ranks, out.width = "100%", fig.height=2.5, fig.width=6}
xstudy_effects <- m %>% 
  ranef() %>% 
  getElement("ResearchID") %>% 
  tibble::rownames_to_column("ResearchID") %>% 
  as_tibble() %>% 
  select(ResearchID, intercept = `(Intercept)`, slope = ot1)

top_20 <- top_n(xstudy_effects, 20, slope)
bot_20 <- top_n(xstudy_effects, 20, -slope)

ggplot(d_m) + 
  aes(x = Time, y = cubic_fit) + 
  geom_line(aes(group = ResearchID), alpha = .2) +
  geom_line(aes(group = ResearchID), data = semi_join(d_m, top_20), 
            size = .7, color = "#0074D9") + 
  geom_line(aes(group = ResearchID), data = semi_join(d_m, bot_20), 
            size = .7, color = "#FF4136") + 
  facet_grid(. ~ Study) + 
  theme_grey(base_size = 9) +
  labs(y = "Proportion looks to target [model fits]", 
       x = "Time after target onset (smoothed to 50 ms bins)",
       caption = "Colors: Top 20 and bottom 20 children by linear time effect")
```

Plot the ranks on the raw data.

```{r ranks-on-raw, out.width = "100%", fig.height=2.5, fig.width=6}
ggplot(d_m) + 
  aes(x = Time, y = Prop) + 
  geom_line(aes(group = ResearchID), alpha = .2) +
  geom_line(aes(group = ResearchID), data = semi_join(d_m, top_20), 
            size = .7, color = "#0074D9") + 
  geom_line(aes(group = ResearchID), data = semi_join(d_m, bot_20), 
            size = .7, color = "#FF4136") + 
  facet_grid(. ~ Study) + 
  labs(y = "Proportion looks to target", 
       x = "Time after target onset (smoothed to 50 ms bins)",
       caption = "Colors: Top 20 and bottom 20 children by linear time effect")
```

## Bayesian model results

Here is the code used to fit the model with Stan. It took about 24 hours to run
the model.

```{r, eval = FALSE}
library(rstanarm)
options(mc.cores = parallel::detectCores())

m <- stan_glmer(
  cbind(Primary, Others) ~
    (ot1 + ot2 + ot3) * Study +
    (ot1 + ot2 + ot3 | ResearchID/Study),
  family = binomial,
  prior = normal(0, 1),
  prior_intercept = normal(0, 5),
  prior_covariance = decov(2, 1, 1),
  data = d_m)
readr::write_rds(m, "./data/stan_aim1_cubic_model.rds.gz")
```

### Fixed effects plots

First, let's plot the intervals for the fixed effects.

```{r}
library(rstanarm)
library(bayesplot)
theme_set(theme_grey())
library(stringr)
library(ggstance)
parse_text <- function(x) parse(text = x)

b <- readr::read_rds("./data/stan_aim1_cubic_model.rds.gz")
b

intervals <- mcmc_intervals_data(as.data.frame(b), pars = names(fixef(b)))

# Rename to use mathematical formatting
intervals$pname <- intervals$parameter %>%
  str_replace("ot(2|3)", "Time^\\1") %>% 
  str_replace("ot(1)", "Time") %>% 
  str_replace(".Intercept.", "Intercept") %>% 
  str_replace("Study", "") %>% 
  str_replace(":", " %*% ") %>% 
  factor(., levels = rev(.))

```

Only the Time^2^ effect is near 0, which is okay. We mostly care about the
intercept and time terms. Here the TimePoint2, TimePoint3, Time x TimePoint2,
and Time x TimePoint3 confirm that children get more reliable and faster each
year of the study.

```{r effects1, out.width = "80%", fig.height=4, fig.width=5}
ggplot(intervals) + 
  aes(y = pname) +
  geom_vline(xintercept = 0, size = 2, color = "white") +
  ggstance::geom_linerangeh(aes(xmin = ll, xmax = hh)) + 
  ggstance::geom_linerangeh(aes(xmin = l, xmax = h), size = 2) +
  geom_point(aes(x = m), size = 3, shape = 3) + 
  scale_y_discrete(labels = parse_text) + 
  labs(x = NULL, y = NULL) + 
  ggtitle("Average effects")
```

Now, let's undo interactions by adding year 1 main effects to interaction
effects and plot the effects for each year of the study.

```{r effects2, out.width = "80%", fig.height=4, fig.width=5}
# Column names will have mathematical formatting too
draws <- as.data.frame(b) %>% 
  as_tibble() %>% 
  transmute(
    `Intercept~~(TP1)` = `(Intercept)`,
    `Intercept~~(TP2)` = `(Intercept)` + StudyTimePoint2,
    `Intercept~~(TP3)` = `(Intercept)` + StudyTimePoint3,
    `Time~~(TP1)` = ot1,
    `Time~~(TP2)` = ot1 + `ot1:StudyTimePoint2`,
    `Time~~(TP3)` = ot1 + `ot1:StudyTimePoint3`,
    `Time^2~~(TP1)` = ot2,
    `Time^2~~(TP2)` = ot2 + `ot2:StudyTimePoint2`,
    `Time^2~~(TP3)` = ot2 + `ot2:StudyTimePoint3`,
    `Time^3~~(TP1)` = ot3,
    `Time^3~~(TP2)` = ot3 + `ot3:StudyTimePoint2`,
    `Time^3~~(TP3)` = ot3 + `ot3:StudyTimePoint3`)

intervals2 <- mcmc_intervals_data(draws) %>% 
  mutate(parameter = factor(parameter, levels = rev(parameter)))

ggplot(intervals2) + 
  aes(y = parameter) +
  geom_vline(xintercept = 0, size = 2, color = "white") +
  ggstance::geom_linerangeh(aes(xmin = ll, xmax = hh)) + 
  ggstance::geom_linerangeh(aes(xmin = l, xmax = h), size = 2) +
  geom_point(aes(x = m), size = 3, shape = 3) + 
  scale_y_discrete(labels = parse_text) + 
  labs(x = NULL, y = NULL) + 
  ggtitle("Average effects by study")
```

Bayesplot supports transformations so we could invert the log-odds measure to
see the intercepts (area under curve/average accuracy) in proportion units.

```{r intercepts, out.width = "80%", fig.height=2, fig.width=5}
intervals3 <- mcmc_intervals_data(draws, regex_pars = "Intercept", 
                                  transformations = "plogis") %>% 
  mutate(parameter = factor(parameter, levels = rev(parameter)))

intervals3 %>% 
  mutate_if(is.numeric, round, 3) %>% 
  select(-point_est) %>% 
  rename(outer = outer_width, inner = inner_width) %>% 
  knitr::kable()

ggplot(intervals3) + 
  aes(y = parameter) +
  geom_vline(xintercept = .25, size = 2, color = "white") +
  ggstance::geom_linerangeh(aes(xmin = ll, xmax = hh)) + 
  ggstance::geom_linerangeh(aes(xmin = l, xmax = h), size = 2) +
  geom_point(aes(x = m), size = 3, shape = 3) + 
  scale_y_discrete(labels = parse_text) + 
  labs(x = NULL, y = NULL) + 
  ggtitle("Average accuracy by year")
```

### Posterior predicted checks


```{r post-pred, out.width = "80%", fig.height=3, fig.width=5}
rstanarm::pp_check(b, nreps = 200, seed = "09272017") + 
  labs(
    x = "Proportion of looks", 
    title = "Observed data and 200 posterior simulations") +
  guides(color = "none") +
  coord_cartesian(xlim = c(0, 1))
```


### Play with the some predictions

Plot the posterior predictions for 9 random participants. This is the model 
simulating new data for these participants.

```{r intercepts, out.width = "100%", fig.height=5, fig.width=5}
set.seed(09272017)
d4 <- d_m %>% 
  sample_n_of(9, ResearchID) %>% 
  tibble::rowid_to_column(".observation")

d4_pred <- posterior_predict(b, d4, draws = 100) %>% 
  reshape2::melt(
    varnames = c(".draw", ".observation"),
    value.name = ".posterior_value") %>% 
  left_join(d4) %>% 
  mutate(trials = Primary + Others)

ggplot(d4_pred) + 
  aes(x = Time, y = Prop, color = Study, group = Study) + 
  geom_line(aes(y = .posterior_value / trials, 
                group = interaction(.draw, Study)), 
            alpha = .20, show.legend = FALSE) + 
  geom_line(size = 1, color = "grey50") + 
  facet_wrap("ResearchID") + 
  labs(title = "Observed data and 100 posterior simulations",
       y = "Proportion looks to target", 
       x = "Time after target onset")
```


### Random effects

```{r}
names(coef(b))
summary(b) %>% as.data.frame %>% tail(30)
mcmc_intervals(as.data.frame(b), regex_pars = "Sigma.Study")
mcmc_intervals(as.data.frame(b), regex_pars = "Sigma.Research")
```






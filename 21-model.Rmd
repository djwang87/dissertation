Aim 2: Notebook
===================




## Coding Notebook

```{r include = FALSE}
knitr::read_chunk("./helpers.R")
if (interactive()) source("./helpers.R")
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r helpers, message = FALSE, warning = FALSE}
```

```{r, include = FALSE}
knitr::opts_chunk$set(cache = TRUE)
```

```{r}

```































```{r}


d_test <- d_tp1 %>%
  # sample_n_of(1, ResearchID) %>%
  filter(ResearchID == "089L") %>%
  mutate(
    Trials_Old = Trials,
    Prop = Target / Trials,
    PropSE = lookr::se_prop(Prop, Trials)) %>% 
  distinct(
    ResearchID, Condition, Time, ot1, ot2, ot3, Prop, PropSE,
    Trials_Old, Target) %>%
  mutate(Trials = 30) %>% 
  augment_linpred(m_tp1, ., nsamples = 100)

d_test <- d_test %>% 
  mutate(Condition = ifelse(Condition == "nonsense", "nonwords", "real words"))


# darker_coral <- scales::hue_pal(c = 35, l = 55)(2)[1]
# darker_turquoise <- scales::hue_pal(c = 35, l = 55)(2)[2]
darker_coral <- constants$col_darker_coral
darker_turquoise <- constants$col_darker_turquoise

constants$col_darker_coral <- scales::hue_pal(c = 35, l = 55)(2)[1]
constants$col_darker_turquoise <- scales::hue_pal(c = 35, l = 55)(2)[2]

ggplot(d_test) + 
  aes(x = Time, y = plogis(.posterior_value), color = Condition) + 
  geom_line(aes(group = interaction(Condition, .draw)), alpha = .2) + 
  geom_pointrange(
    data = . %>% filter(Condition == "nonwords"),
    aes(
      y = Prop, 
      ymin = Prop - PropSE, 
      ymax = Prop + PropSE, 
      group = Condition), 
    color = darker_coral) +
  geom_pointrange(
    data = . %>% filter(Condition == "real words"),
    aes(
      y = Prop, 
      ymin = Prop - PropSE, 
      ymax = Prop + PropSE, 
      group = Condition), 
    color = darker_turquoise) +
  geom_text(
    aes(y = Prop, label = Condition),
    data = data_frame(
      Time = c(500, 1200), 
      Condition = c("real words", "nonwords"), 
      Prop = c(.9, .1)),
    family = "Lato Medium") +
  labs(
    title = "One child's data at age 3",
    x = constants$x_time,
    y = constants$y_prop_target,
    caption = 
      "Intervals: Observed proportions Â± SE. Lines: 100 posterior fits") + 
  guides(color = FALSE)


```




Steps to do...

- Describe the slope and peaks for each condition in each year
- Quantify the difference between the conditions
- When do the differences happen?
- Find children with large differences in peaks.


## Changes in referent selection

```{r}

# peaks %>% 
#   mutate(Study = factor(Study, c("TimePoint2", "TimePoint1", "TimePoint3"))) %>% 
#   filter(.draw == 1) %>% 
#   select(-diff) %>% 
#   tidyr::gather("Condition", "Peak", -Study, -ResearchID, -.draw) %>% 
#   lme4::lmer(Peak ~ Condition * Study + (1 | ResearchID), .) %>% 
#   summary()

# peaks %>% 
#   # filter(.draw == 1) %>% 
#   mutate(Study = factor(Study, c("TimePoint2", "TimePoint1", "TimePoint3"))) %>% 
#   lm(nonsense ~ Study, .) %>% 
#   summary()

peaks %>% 
 filter(.draw == 1) %>% 
  mutate(Study = factor(Study, c("TimePoint2", "TimePoint1", "TimePoint3"))) %>% 
  lm(nonsense ~ Study, .) %>% 
  summary()

ggplot(real_peaks) + 
  aes(x = term, y = estimate) + 
  stat_summary(fun.data = median_hilow)

# ggplot(do_it_1) + 
#   aes(x = Study, y = nonsense) + 
#   stat_summary(aes(color = "nonwords"), fun.data = mean_se)  + 
#   stat_summary(aes(y = real, color = "real words"))  
  
# do_it_1 %>% 
#   lm(diff ~ Study, .) %>% 
#   summary()

# do_it_2 <- peaks %>% 
#   group_by(Study, ResearchID, .draw) %>%
#   summarise_at(vars(nonsense:diff), funs(mean)) %>%
#   ungroup() %>% 
#   select(Study, nonsense:diff) %>% 
#   mutate(Study = factor(Study, c("TimePoint2", "TimePoint1", "TimePoint3"))) %>% 
#   lm(nonsense ~ Study, .) %>% 
#   summary()
#   
#   tidyr::nest(-Study) %>% 
#   mutate(intervals = lapply(data, bayesplot::mcmc_intervals_data)) %>% 
#   select(-data) %>% 
#   tidyr::unnest(intervals)

# do_it <- peaks %>% 
#   group_by(Study, .draw) %>%
#   mutate(n = n()) %>%
#   summarise_at(vars(n, nonsense:diff), funs(mean)) %>%
#   select(Study, nonsense:diff) %>% 
#   tidyr::nest(-Study) %>% 
#   mutate(intervals = lapply(data, bayesplot::mcmc_intervals_data)) %>% 
#   select(-data) %>% 
#   tidyr::unnest(intervals)
# 
# peaks %>% 
#   filter(.draw == 1) %>% 
#   ggplot() + 
#     aes(x = real, y = Study, height = stat(density)) + 
#     ggridges::geom_density_ridges(stat = "binline", binwidth = .05, center = .025)
#         geom_density_ridges(stat = "binline", bins = 20, scale = 0.95, draw_baseline = FALSE)
# rel_min_height = .01, jittered_points = TRUE, position = "raincloud", scale = 0.8) + 
#     coord_cartesian(xlim = c(0, 1))
#   geom_point() + 
#     geom_segment(aes(yend = parameter + .01, x = ll, xend = hh), position = position_dodge(width = .1))
# 
#     geom_density_ridges(jittered_points = TRUE, position = "raincloud",
#                       alpha = 0.7, scale = 0.9)
# 
# # Examples of coloring by ecdf or quantiles
# library(viridis)
# library(ggridges)
# ggplot(iris, aes(x=Sepal.Length, y=Species, fill=factor(..quantile..))) +
#   stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE,
#                       quantiles = 5) +
#   scale_fill_viridis(discrete = TRUE, name = "Quintiles") + theme_ridges() +
#   scale_y_discrete(expand = c(0.01, 0))
# 
# ggplot(iris, aes(x=Sepal.Length, y=Species, fill=0.5 - abs(0.5-..ecdf..))) +
#   stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE) +
#   scale_fill_viridis(name = "Tail probability", direction = -1) + theme_ridges() +
#   scale_y_discrete(expand = c(0.01, 0))
# 
# ggplot(iris, aes(x=Sepal.Length, y=Species, fill=factor(..quantile..))) +
#   stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE,
#                       quantiles = c(0.05, 0.95)) +
#   scale_fill_manual(name = "Probability\nranges",
#                     values = c("red", "grey80", "blue")) +
#   theme_ridges() + scale_y_discrete(expand = c(0.01, 0))
#   
#   
# ggplot(do_it) + 
#   aes(x = m, y = parameter, color = Study) + 
#   geom_point() + 
#   geom_segment(aes(yend = parameter + .01, x = ll, xend = hh), position = position_dodge(width = .1))
```


<!-- To evaluate the growth curve peaks, I computed the growth curve peak for -->
<!-- each participant x study x condition in each posterior sample and -->
<!-- averaged over the posterior to get an average growth curve peak. I used -->
<!-- a linear mixed effects model to regress growth curve peak onto age group -->
<!-- and experimental condition and age x condition with randomly varying -->
<!-- intercepts for each child and each child-year. -->

The growth curve peaks follow a similar pattern of results. At age 3,
the average peak value was ... for real words and ... for nonwords. The
conditions did not significantly differ at this age. The nonword peaks
were significantly higher greater than real word peaks at age 4 [blah
vs. blah, p=value.] and at age 5 although the difference was smaller
[blah vs. blah, p=value.].

Importantly, the average real word peaks was xx at age 3 which that
children were beginning to reach ceiling performance early on. This is a
task for toddlers.

```{r}
rw_peak_lme_tp2
nw_peak_lme_tp3
```





















```{r}
# peaks %>% 
#   mutate(Study = convert_study_to_age(Study)) %>% 
#   select(-diff) %>% 
#   group_by(Study, ResearchID) %>% 
#   summarise_at(vars(nonsense:real), mean) %>% 
#   ungroup() %>% 
#   tidyr::gather("Condition", "Value", nonsense:real) %>% 
#   tidyr::unite("Var", c("Study", "Condition")) %>% 
#   tidyr::spread(Var, Value) %>% 
#   select(-1) %>% 
#   as.matrix() %>% 
#   Hmisc::rcorr()
  
```






```{r}

# 
# model_one <- function(data) {
#   lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense) + scale(real), data)
# }
# 
# nested <- w_evt_dist %>% 
#   tidyr::nest(-.draw) %>% 
#   mutate(
#     model = data %>% purrr::map(model_one), 
#     glance = model %>% purrr::map(broom::glance),
#     coefs =  model %>% purrr::map(broom::tidy)) %>% 
#   select(-model, -data) %>% 
#   tidyr::unnest(glance) %>% 
#   select(-(statistic:df), -df.residual) %>% 
#   tidyr::unnest(coefs)
# ggplot(nested) + 
#   aes(x = term, y = estimate) + 
#   stat_summary(fun.data = median_hilow)


library(rstanarm)
zzzzz <- stan_glm(
  scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense) + scale(real),
  data = w_evt,
  family = gaussian,
  prior = normal(0, .5, autoscale = FALSE))
bayesplot::mcmc_intervals(as.matrix(zzzzz))
bayesplot::mcmc_intervals(cbind(as.matrix(zzzzz), r2 = bayes_R2(zzzzz)))

w_evt2 <- na.omit(w_evt)
ppcor::pcor.test(w_evt2$TimePoint3, w_evt2$diff, w_evt2$TimePoint1)
ppcor::pcor.test(w_evt2$TimePoint3, w_evt2$TimePoint1, w_evt2$diff)


summary(lm(TimePoint3 ~ scale(TimePoint1) + I(diff * 10) + scale(real), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + I(diff * 10) + scale(real), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + I(diff * 10) + scale(real), w_evt))


summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + qlogis(nonsense), w_evt))

summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense) + scale(real), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(diff) + scale(real), w_evt))

lmSupport::modelEffectSizes(
  lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense), w_evt),
  Print = TRUE, Digits = 4)

lmSupport::modelRmd("scale(TimePoint1)",
  lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense), w_evt))

lmSupport::modelCompare(
  lm(scale(TimePoint3) ~ scale(TimePoint1), w_evt),
  lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense), w_evt)
)

summary()
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(diff), w_evt))


summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(real), w_evt))

plot(density(rnorm(1000, 0, .5)))

```


When it comes to predicting age 5 vocabulary, the peak of the age 3 real word curve conveys no information over and above age 3 vocabulary level. The age 3 nonword peak or the difference in age 3 peaks both predicted age 5 vocabulary. If I had to choose one of these measure, I would prefer the nonword peak the difference measure can hide poor performance. In the data below, at diff = 0, the range of nonword peaks span from .25 to 1. A difference of 0 can capture ceiling and floor performance in both tasks.


```{r}
ggplot(w_evt) + 
  aes(x = diff, y = nonsense) + 
  geom_point()

ggplot(diffs) + 
  aes(x = real, y = nonsense) + 
  stat_smooth(method = "lm") + 
  geom_point() +
  facet_wrap("Study") + 
  geom_abline(slope = 1, intercept = 0) + 
  expand_limits(x = 0)
```



```{r}
scores <- readr::read_csv("./data-raw/test_scores.csv")
tp1 <- scores %>% filter(Study == "TimePoint1")
tp2 <- scores %>% filter(Study == "TimePoint2")
tp3 <- scores %>% filter(Study == "TimePoint3")

diffs %>% 
  inner_join(tp3) %>% 
  ggplot() + 
    aes(x = diff, y = EVT_Standard) + 
    geom_point() +
    stat_smooth(method = "lm")

w_evt <- scores %>% 
  filter(Study != "TimePoint2") %>% 
  select(ResearchID, Study, EVT_Standard) %>% 
  tidyr::spread(Study, EVT_Standard) %>% 
  left_join(diffs)

summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(diff), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(real), w_evt))


diffs %>% 
  inner_join(tp3) %>% 
  ggplot() + 
    aes(x = real, y = EVT_Standard) + 
    geom_point() +
    stat_smooth(method = "lm")

diffs %>% 
  inner_join(tp3) %>% 
  select(diff, real, nonsense, EVT_Standard) %>% 
  as.matrix(.) %>% 
  Hmisc::rcorr()
```


```{r}
# library(rstanarm)
# options(mc.cores = parallel::detectCores())

# m_e <- stan_glmer(
#   cbind(Target, Distractor) ~ 
#     (ot1 + ot2 + ot3) * Study * Condition  + 
#     (ot1 + ot2 + ot3 | ResearchID/Condition/Study),
#   family = binomial,
#   prior = normal(0, 2, autoscale = FALSE),
#   prior_intercept = normal(0, 2, autoscale = FALSE),
#   prior_covariance = decov(2, 1, 1),
#   data = d_r_nw_dis)
# readr::write_rds(m_e, "stan_me.rds")
# readr::write_rds(m_e, "stan_me.rds.gz")
```


```{r}
m_e <- readr::read_rds("stan_me.rds.gz")
d <- posterior_linpred(m_e, draws = 1000)
ncol(d)
nrow(d_r_nw_dis)

dlong <- d %>% 
  as.data.frame() %>% 
  tibble::rowid_to_column(".draw") %>% 
  as_tibble() %>% 
  tidyr::gather(".observation", ".estimate", -.draw) %>% 
  mutate(.observation = as.numeric(.observation))

big_big <- d_r_nw_dis %>% 
  tibble::rowid_to_column(".observation") %>% 
  select(.observation:Condition, Time) %>% 
  left_join(dlong) %>% 
  select(-.observation) %>% 
  tidyr::spread(Condition, .estimate)

big_big <- big_big %>% 
  mutate(
    diff_prop = plogis(real) - plogis(nonsense), 
    real = plogis(real), nonsense = plogis(nonsense))

big_big <- big_big %>% 
  tidyr::gather("Condition", "value", nonsense:diff_prop) 

library(ggplot2)
big_big %>% 
  mutate(
    Condition = ifelse(Condition == "diff_prop", "Real - Nonword", Condition),
    Condition = ifelse(Condition == "nonsense", "Nonword", Condition),
    Condition = ifelse(Condition == "real", "Real word", Condition)) %>%
  filter(Study == "TimePoint1") %>% 
  group_by(Study, .draw, Time, Condition) %>% 
  summarise(value = median(value)) %>% 
  ggplot() + 
    aes(x = Time, y = value) + 
    stat_summary(fun.data = median_hilow) + 
    facet_wrap("Condition")

head(d[1, 1:5])
library(bayesplot)
pp_check(test_m, nsample = 200)


```




```{r}

diff_aug <- aug %>% 
  mutate(
    Prop = plogis(elog),
    PropFitted = plogis(.fitted)) %>% 
  select(Study:Condition, Time, Prop, PropFitted, elog, .fitted) %>% 
  tidyr::gather("measure", "value", elog, .fitted, Prop, PropFitted) %>% 
  tidyr::spread(Condition, value) %>% 
  mutate(`real - nonsense` = real - nonsense) %>% 
  tidyr::gather("Condition", "value", nonsense:`real - nonsense`) %>% 
  tidyr::spread(measure, value)

ggplot(diff_aug) + 
  aes(x = Time, y = Prop , color = Condition, linetype = Condition) +
  geom_hline(color = "white", size = 2, yintercept = .5) +
  stat_summary() + 
  stat_summary(aes(y = PropFitted), geom = "line", fun.y = mean) +
  facet_wrap("Study")

diff_aug %>% 
  filter(Condition == "real - nonsense") %>% 
  ggplot() + 
    aes(x = Time, y = Prop) +
    geom_hline(color = "white", size = 2, yintercept = 0) +
    stat_summary(fun.data = median_hilow, size = 1.5,
                 geom = "linerange",
                 fun.args = list(conf.int = .5)) +
    stat_summary(fun.data = median_hilow, 
                 fun.args = list(conf.int = .9)) +
    geom_hline(color = "white", size = .25, yintercept = 0) +
    facet_wrap("Study")


```






```{r explore-rts, eval = FALSE}
da <- readr::read_csv("./data/aim2-screened.csv.gz")

rts <- da %>% 
  filter(
    Bias_Fam %in% c("Familiar", "Unfamiliar"), 
    0 <= Time,
    GazeByImageAOI %in% c("Target", "Distractor")) %>% 
  group_by(
    Study, Condition, ResearchID, TrialNo, TrialID, 
    Bias_ImageAOI, GazeByImageAOI) %>% 
  summarise(FirstLook = min(Time)) %>% 
  ungroup()

rts %>% 
  filter(
    200 <= FirstLook,
    Condition == "real",
    Bias_ImageAOI != GazeByImageAOI,
    Bias_ImageAOI == "Distractor") %>% 
  ggplot() + 
    aes(x = FirstLook) + 
    geom_histogram() +
    facet_wrap(Study ~ Condition)

rts %>% 
  filter(
    200 <= FirstLook,
    Condition == "real",
    Bias_ImageAOI != GazeByImageAOI,
    Bias_ImageAOI == "Distractor") %>% 
  ggplot() + 
    aes(x = Study, y = FirstLook) + 
    geom_point(position = position_jitter(width = .1)) + 
    stat_summary(color = "red") + 
    scale_y_log10()

rts %>% 
  filter(
    200 <= FirstLook,
    Bias_ImageAOI != GazeByImageAOI,
    Bias_ImageAOI == "Distractor",
    Condition != "nonsense") %>% 
  ggplot() + 
    aes(y = interaction(Study, Condition), x = FirstLook) + 
    ggridges::stat_density_ridges()  

rts %>% 
  filter(
    200 <= FirstLook,
    Condition == "real",
    Bias_ImageAOI != GazeByImageAOI,
    Bias_ImageAOI == "Distractor") %>% 
  ggplot() + 
    aes(x = Study, y = FirstLook) + 
    # geom_point(position = position_jitter(width = .1)) + 
    stat_summary(
      aes(group = ResearchID), 
      position = position_jitter(width = .2)) + 
    stat_summary(color = "red") + 
    scale_y_log10()

d_test <- rts %>% 
  filter(
    200 <= FirstLook,
    Condition == "real",
    Bias_ImageAOI != GazeByImageAOI,
    Bias_ImageAOI == "Distractor") %>% 
  mutate(S = factor(Study, c("TimePoint2", "TimePoint1", "TimePoint3")))

library(lme4)
try <- lmer(log(FirstLook) ~ S + (1 | ResearchID/S), d_test)
summary(try)

```

```{r bayes-dead-end, eval = FALSE, include = FALSE}
# library(rstanarm)
# try <- stan_glmer(
#   log(FirstLook) ~ S + (1 | ResearchID/S), 
#   d_test, 
#   family = gaussian(),
#   prior = normal(0, 1),
#   chains = 1, 
#   iter = 1000)
# summary(try)
# 
# pp_check(try)
# pp <- posterior_predict(try)
# t1 <- which(d_test$Study == "TimePoint1")
# t2 <- which(d_test$Study == "TimePoint2")
# t3 <- which(d_test$Study == "TimePoint3")
# 
# bayesplot::ppc_dens_overlay(log(d_test$FirstLook[t1]), yrep = pp[, t1], size = 0.25, alpha = 0.7, trim = FALSE,
#   bw = "nrd0", adjust = 1, kernel = "gaussian", n_dens = 1024)
# 
# bayesplot::ppc_dens_overlay(
#   log(d_test$FirstLook[t1]), 
#   yrep = pp[sample(1:500, size = 50), t1])
# 
# bayesplot::ppc_dens_overlay(
#   d_test$FirstLook[t1], 
#   yrep = exp(pp[sample(1:500, size = 50), t1])) + 
#   ggtitle("FirstLook ~ Study + (1 | ID/Study), Age 3, Real, Unfamiliar Initial") + 
#   labs(caption = "Density of posterior predictions")
# ggsave("misc/bayes-rts-real-age3-unfam.png")
# 
# bayesplot::ppc_dens_overlay(
#   d_test$FirstLook[t2], 
#   yrep = exp(pp[sample(1:500, size = 50), t2])) + 
#   ggtitle("FirstLook ~ Study + (1 | ID/Study), Age 4, Real, Unfamiliar Initial") + 
#   labs(caption = "Density of posterior predictions")
# ggsave("misc/bayes-rts-real-age4-unfam.png")
# 
# 
# bayesplot::ppc_dens_overlay(
#   d_test$FirstLook[t3], 
#   yrep = exp(pp[sample(1:500, size = 50), t3])) + 
#   ggtitle("FirstLook ~ Study + (1 | ID/Study), Age 5, Real, Unfamiliar Initial") + 
#   labs(caption = "Density of posterior predictions")
# ggsave("misc/bayes-rts-real-age5-unfam.png")
# 
```
















```{r}

test_f <- bf(
  elog ~ 
    (ot1 + ot2 + ot3) * Condition + 
    (ot1 + ot2 + ot3 | ResearchID/Condition), 
  family = gaussian)

prior_intercept <- set_prior("normal(0, 1)", class = "Intercept")
prior_b <- set_prior("normal(0, 1)", class = "b")
prior_ot1 <- set_prior("normal(0, 2)", class = "b", coef = "ot1")
prior_cor <- set_prior("lkj(2)", class = "cor")
prior_sd <- set_prior("student_t(3, 0, 1)", class = "sd")
prior_sigma <- set_prior("student_t(3, 0, 1)", class = "sigma")
priors <- c(prior_intercept, prior_b, prior_ot1, prior_cor, prior_sd, prior_sigma)

```


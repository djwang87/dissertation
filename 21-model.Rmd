Aim 2: Notebook
===================




## Coding Notebook

```{r include = FALSE}
knitr::read_chunk("./helpers.R")
if (interactive()) source("./helpers.R")
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r helpers, message = FALSE, warning = FALSE}
```

```{r, include = FALSE}
knitr::opts_chunk$set(cache = TRUE)
```


```{r, include = FALSE}
d <- readr::read_csv("./data/aim2-model-ready.csv.gz") %>% 
  filter(!is.na(Bias_Fam)) %>% 
  filter(300 <= Time) %>% 
  select(-starts_with("ot")) %>% 
  polypoly::poly_add_columns(
    Time, degree = 3, scale_width = 1, prefix = "ot")
```



```{r, include = FALSE}
# Flip things so that the nonword and real-word curves go upward
d_r_ui <- d %>% 
  filter(Condition == "real", Bias_Fam == "Unfamiliar") %>% 
  mutate(elog = empirical_logit(Target, Distractor))

d_bias_target <- tibble::tribble(
  ~Condition, ~Bias_Fam, ~Bias_Target,
  "nonsense", "Familiar", "Distractor",
  "nonsense", "Unfamiliar", "Target",
  "real", "Familiar", "Target",
  "real", "Unfamiliar", "Distractor")

d_r_nw_vs <- d %>% 
  select(-Primary, -.response_def, -Prop, -PropSE) %>% 
  filter(Condition != "MP") %>% 
  rename(Unfamiliar = Distractor, Familiar = Target) %>% 
  mutate(
    Target = ifelse(Condition == "nonsense", Unfamiliar, Familiar), 
    Distractor = ifelse(Condition == "nonsense", Familiar, Unfamiliar),
    Trials = Target + Distractor) %>% 
  left_join(d_bias_target) %>% 
  mutate(elog = empirical_logit(Target, Distractor))

d_r_nw_dis <- d_r_nw_vs %>% 
  filter(Bias_Target == "Distractor")

study_child_with_empty_cells <- d_r_nw_dis %>% 
  filter(Trials < 4) %>% 
  distinct(Study, ResearchID)

study_counts <- study_child_with_empty_cells %>% 
  count(Study) %>% 
  split(.$Study) %>% 
  lapply(pull, n) %>% 
  set_names(stringr::str_replace, "TimePoint", "T")

study_counts <- list(study_counts$n) %>% 
  set_names(study_counts$Study)

d_r_nw_dis <- d_r_nw_dis %>% 
  anti_join(study_child_with_empty_cells)
```

  - I model data from `r min(d$Time)` ms to `r max(d$Time)`.
  - I flipped the growth curve for the nonword condition so that it
    reflects the proportion of looking to the unfamiliar object when
    presented a nonword. Both the real word and nonword conditions
    measure referent selection as the probability of fixating on the
    appropriate referent when presented with a label.
  - I removed any Study x Child levels if a child had fewer than 4
    fixations in a single time bin. Put another way, children had to
    have at least 4 looks to one of the images in every 50 ms time bin.
    This screening removed `r study_counts$T1` children from Age 3,
    `r study_counts$T2` from Age 4, and `r study_counts$T3` from Age 5.



```{r}
library(brms)

d_r_nw_dis <- d_r_nw_dis %>% 
  select(
    Study, ResearchID, Condition, Time, ot1:ot3, Target, Distractor, 
    Trials, elog)

d_tp1 <- d_r_nw_dis %>%
  filter(Study == "TimePoint1") 

d_tp2 <- d_r_nw_dis %>%
  filter(Study == "TimePoint2") 

d_tp3 <- d_r_nw_dis %>%
  filter(Study == "TimePoint3") 

m_tp1 <- readr::read_rds("data/tp1_mp.rds.gz")
m_tp2 <- readr::read_rds("data/tp2_mp.rds.gz")
m_tp3 <- readr::read_rds("data/tp3_mp.rds.gz")

test_m <- m_tp2

summary(test_m)
prior_summary(test_m)

test_data <- d_tp2
sss <- test_data$ResearchID %>% unique() %>% sample(8)

n1 <- test_data %>% 
  distinct(Condition, Time, ot1, ot2, ot3) %>% 
  tidyr::crossing(., ResearchID = sss) %>% 
  mutate(Trials = 30)

n_tp1_all <- d_tp1 %>% 
  distinct(Study, ResearchID, Condition, Time, ot1, ot2, ot3) %>% 
  mutate(Trials = 30)

n_tp2_all <- d_tp2 %>% 
  distinct(Study, ResearchID, Condition, Time, ot1, ot2, ot3) %>% 
  mutate(Trials = 30)

n_tp3_all <- d_tp3 %>% 
  distinct(Study, ResearchID, Condition, Time, ot1, ot2, ot3) %>% 
  mutate(Trials = 30)

n2 <- test_data %>% 
  distinct(Condition, Time, ot1, ot2, ot3) %>% 
  tidyr::crossing(., ResearchID = "Simulated new participants (500)") %>% 
  mutate(Trials = 30)

augment_linpred <- function(model, data, ...) {
  model %>% 
    posterior_linpred(newdata = data, ...) %>% 
    as.data.frame() %>% 
    as_tibble() %>% 
    rlang::set_names(seq_len(nrow(data))) %>% 
    tibble::rowid_to_column(".draw") %>% 
    tidyr::gather(".observation", ".posterior_value", -.draw) %>% 
    mutate(.observation = as.numeric(.observation)) %>% 
    left_join(
      data %>% tibble::rowid_to_column(".observation"),
      by = ".observation")
}

pl1 <- augment_linpred(
  test_m, n1, allow_new_levels = TRUE, re_formula = NULL, nsamples = 200)

pl2 <- augment_linpred(
  test_m, n2, allow_new_levels = TRUE, re_formula = NULL, nsamples = 500)

inv_logit <- function(x) 1 / (1 + exp(-x))
pl <- bind_rows(pl1, pl2)

ggplot(pl) + 
  aes(x = Time, y = inv_logit(.posterior_value), color = Condition) +
  geom_line(
    aes(group = interaction(.draw, Condition)), 
    alpha = .05) +
  geom_line(
    aes(y = Target / Trials, group = Condition),
    data = test_data %>% filter(ResearchID %in% sss),
    color = "grey20") + 
  facet_wrap("ResearchID") + 
  # theme_solarized_2(light = FALSE) + 
  # scale_color_solarized() + 
  guides(color = guide_legend(override.aes = list(alpha = 1))) +
  labs(
    title = "Example observed means and 200 posterior fits",
    x = constants$x_time,
    y = constants$y_prop_target,
    caption = "Sample of 8 of 155 total participants")



diffs <- pl2 %>% 
  select(.draw, .posterior_value, Condition, Time) %>% 
  tidyr::spread(Condition, .posterior_value) %>% 
  mutate(
    nonsense_prop = plogis(nonsense), 
    real_prop = plogis(real),
    `real - nonsense` = real_prop - nonsense_prop) %>% 
  select(.draw, Time, nonsense_prop, real_prop, `real - nonsense`)

ggplot(diffs) + 
  aes(x = Time, y = `real - nonsense`) + 
  geom_line(aes(group = .draw), alpha = .1) + 
  stat_summary(fun.data = median_hilow) + 
  ggtitle("Simulated participants")


pl3 <- augment_linpred(
  test_m, n2, allow_new_levels = TRUE, re_formula = NA, nsamples = 500)


diffs_2 <- pl3 %>% 
  select(.draw, .posterior_value, Condition, Time) %>% 
  tidyr::spread(Condition, .posterior_value) %>% 
  mutate(
    nonsense_prop = plogis(nonsense), 
    real_prop = plogis(real),
    `real - nonsense` = real_prop - nonsense_prop) %>% 
  select(.draw, Time, nonsense_prop, real_prop, `real - nonsense`)

ggplot(diffs_2) + 
  aes(x = Time, y = `real - nonsense`) + 
  geom_line(aes(group = .draw), alpha = .1) + 
  stat_summary(fun.data = median_hilow) + 
  ggtitle("Fixed effects predictions")

ggplot(diffs_2) + 
  aes(x = Time, y = real_prop) + 
  geom_line(aes(group = .draw), alpha = .1) + 
  stat_summary(fun.data = median_hilow) + 
  ggtitle("Fixed effects predictions")

emp_diffs <- d_tp2 %>% 
  select(ResearchID, elog, Condition, Time) %>% 
  tidyr::spread(Condition, elog) %>% 
  mutate(
    nonsense_prop = plogis(nonsense), 
    real_prop = plogis(real),
    `real - nonsense` = real_prop - nonsense_prop) %>% 
  select(ResearchID, Time, nonsense_prop, real_prop, `real - nonsense`)

ggplot(emp_diffs) + 
  aes(x = Time, y = `real - nonsense`) + 
  geom_line(aes(group = ResearchID), alpha = .1) + 
  stat_summary(fun.data = mean_cl_boot) + 
  ggtitle("Empirical differences")




pl2 %>% 
  ggplot() + 
    aes(x = Time, y = .posterior_value, color = Condition) + 
    stat_summary(fun.data = median_hilow)

pl4 <- augment_linpred(
  test_m, n1, allow_new_levels = TRUE, re_formula = NULL, nsamples = 500)


diffs_4 <- pl4 %>% 
  select(.draw, ResearchID, .posterior_value, Condition, Time) %>% 
  tidyr::spread(Condition, .posterior_value) %>% 
  mutate(
    nonsense_prop = plogis(nonsense), 
    real_prop = plogis(real),
    `real - nonsense` = real_prop - nonsense_prop) %>% 
  select(.draw, ResearchID, Time, nonsense_prop, real_prop, `real - nonsense`)


ggplot(diffs_4) + 
  aes(x = Time, y = `real - nonsense`) + 
  stat_summary(aes(group = .draw), fun.y = mean, geom = "line") + 
  stat_summary(
    data = emp_diffs %>% semi_join(n1 %>% select(ResearchID)), color = "pink") + 
  ggtitle("average for n=8")


pl5 <- augment_linpred(
  test_m, n_all, allow_new_levels = TRUE, re_formula = NULL, nsamples = 500)


diffs_5 <- pl5 %>% 
  select(.draw, ResearchID, .posterior_value, Condition, Time) %>% 
  tidyr::spread(Condition, .posterior_value) %>% 
  mutate(
    nonsense_prop = plogis(nonsense), 
    real_prop = plogis(real),
    `real - nonsense` = real_prop - nonsense_prop) %>% 
  select(.draw, ResearchID, Time, nonsense_prop, real_prop, `real - nonsense`)


ggplot(diffs_5) + 
  aes(x = Time, y = `real - nonsense`) + 
  geom_hline(yintercept = 0) +
  expand_limits(y = c(-.2, .2)) +
  stat_summary(aes(group = .draw), fun.y = mean, geom = "line") + 
  stat_summary(
    data = emp_diffs %>% semi_join(n_all %>% select(ResearchID)), color = "pink") 

ggplot(diffs_5) + 
  aes(x = Time, y = real_prop ) + 
  geom_hline(yintercept = 0) +
  expand_limits(y = c(-.2, .2)) +
  stat_summary(aes(group = .draw), fun.y = mean, geom = "line") + 
  stat_summary(
    data = emp_diffs %>% semi_join(n_all %>% select(ResearchID)), color = "blue") 

ggplot(diffs_5) + 
  aes(x = Time, y = nonsense_prop ) + 
  geom_hline(yintercept = 0) +
  expand_limits(y = c(-.2, .2)) +
  stat_summary(aes(group = .draw), fun.y = mean, geom = "line") + 
  stat_summary(
    data = emp_diffs %>% semi_join(n_all %>% select(ResearchID)), color = "blue") 
```


Steps to do...

- Describe the slope and peaks for each condition in each year
- Quantify the difference between the conditions
- When do the differences happen?
- Find children with large differences in peaks.

```{r}
tp1_fits <- augment_linpred(
  m_tp1, n_tp1_all, allow_new_levels = TRUE, 
  re_formula = NULL, nsamples = 500)

tp2_fits <- augment_linpred(
  m_tp2, n_tp2_all, allow_new_levels = TRUE, 
  re_formula = NULL, nsamples = 500)

tp3_fits <- augment_linpred(
  m_tp3, n_tp3_all, allow_new_levels = TRUE, 
  re_formula = NULL, nsamples = 500)

get_peaks <- . %>% 
  group_by(Study, ResearchID, Condition, .draw) %>% 
  top_n(5, .posterior_value) %>% 
  summarise(med = median(plogis(.posterior_value))) 

peaks <- bind_rows(
  tp1_fits %>% get_peaks(), 
  tp2_fits %>% get_peaks(), 
  tp3_fits %>% get_peaks())

diff_dist <- peaks %>%
  ungroup() %>% 
  tidyr::spread(Condition, med) %>% 
  mutate(diff = real - nonsense)

diffs <- diff_dist %>% 
  group_by(Study, ResearchID) %>% 
  summarise_at(vars(real, nonsense, diff), .funs = mean) %>% 
  ungroup()

ant <- data_frame(
  diff = .6, 
  Study = "Age 3", 
  label = "Real word curves had higher peaks")

ant2 <- data_frame(
  diff = -.6, 
  Study = "Age 3", 
  label = "Nonword curves had higher peaks")

diffs %>% 
  mutate(Study = convert_study_to_age(Study)) %>% 
  ggplot() + 
    aes(x = Study, y = diff) + 
    geom_text(
      aes(label = label), 
      data = bind_rows(ant, ant2), nudge_x = -.45, hjust = 0, 
      color = "grey20", size = 3) +
    geom_hline(yintercept = 0, size = 2, color = "white") + 
    geom_point(position = position_jitter(width = .2), alpha = .3, shape = 1) +
    stat_summary(fun.y = mean, geom = "point", size = 2) + 
  labs(
    title = "Differences in growth curve peaks",
    x = NULL,
    y = "Real word peak - nonword peak",
    caption = "Open points: Participant means. Closed: Mean of means.")

```

## Which type of referent selection better predicts age 5 vocabulary

In chapter X, I found that peak looking probability at age 3 was
positively correlated with age 5 vocabulary. Above, I showed that the
growth curve peaks differed between the two condition, especially at
age 3. Therefore, one question is which growth curve measures best
predicts vocabulary at age 5.

For these analyses, I regressed Age 5 expressive vocabulary standard score onto the Age 3 expressive vocabuulary score, Age 3 real word peak and Age 3 nonword peaks.

```{r}
scores <- readr::read_csv("./data-raw/test_scores.csv")
tp1 <- scores %>% filter(Study == "TimePoint1")
tp2 <- scores %>% filter(Study == "TimePoint2")
tp3 <- scores %>% filter(Study == "TimePoint3")

diffs %>% 
  inner_join(tp3) %>% 
  ggplot() + 
    aes(x = diff, y = EVT_Standard) + 
    geom_point() +
    stat_smooth(method = "lm")

# w_evt_dist <- scores %>% 
#   filter(Study != "TimePoint2") %>% 
#   select(ResearchID, Study, EVT_Standard) %>% 
#   tidyr::spread(Study, EVT_Standard) %>% 
#   inner_join(diff_dist)



w_evt <- scores %>% 
  filter(Study != "TimePoint2") %>% 
  select(ResearchID, Study, EVT_Standard) %>% 
  tidyr::spread(Study, EVT_Standard) %>% 
  inner_join(diffs %>% filter(Study == "TimePoint1"))


# 
# model_one <- function(data) {
#   lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense) + scale(real), data)
# }
# 
# nested <- w_evt_dist %>% 
#   tidyr::nest(-.draw) %>% 
#   mutate(
#     model = data %>% purrr::map(model_one), 
#     glance = model %>% purrr::map(broom::glance),
#     coefs =  model %>% purrr::map(broom::tidy)) %>% 
#   select(-model, -data) %>% 
#   tidyr::unnest(glance) %>% 
#   select(-(statistic:df), -df.residual) %>% 
#   tidyr::unnest(coefs)
# ggplot(nested) + 
#   aes(x = term, y = estimate) + 
#   stat_summary(fun.data = median_hilow)


library(rstanarm)
zzzzz <- stan_glm(
  scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense) + scale(real),
  data = w_evt,
  family = gaussian,
  prior = normal(0, .5, autoscale = FALSE))
bayesplot::mcmc_intervals(as.matrix(zzzzz))
bayesplot::mcmc_intervals(cbind(as.matrix(zzzzz), r2 = bayes_R2(zzzzz)))

w_evt2 <- na.omit(w_evt)
ppcor::pcor.test(w_evt2$TimePoint3, w_evt2$diff, w_evt2$TimePoint1)
ppcor::pcor.test(w_evt2$TimePoint3, w_evt2$TimePoint1, w_evt2$diff)
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(diff), w_evt))
summary(lm(TimePoint3 ~ TimePoint1 + scale(diff), w_evt))
summary(lm(TimePoint3 ~ TimePoint1 + I(diff * 100), w_evt))





w_evt %>%
  modelr::add_residuals(lm(TimePoint3 ~ TimePoint1, .)) %>%
  ggplot() +
    aes(x = diff, y = resid) +
    geom_point() +
    stat_smooth(method = "lm")


summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense) + scale(real), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(diff) + scale(real), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(diff), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(real), w_evt))

plot(density(rnorm(1000, 0, .5)))

```



When it comes to predicting age 5 vocabulary, the peak of the age 3 real word curve conveys no information over and above age 3 vocabulary level. The age 3 nonword peak or the difference in age 3 peaks both predicted age 5 vocabulary. If I had to choose one of these measure, I would prefer the nonword peak the difference measure can hide poor performance. In the data below, at diff = 0, the range of nonword peaks span from .25 to 1. A difference of 0 can capture ceiling and floor performance in both tasks.


```{r}
ggplot(w_evt) + 
  aes(x = diff, y = nonsense) + 
  geom_point()

ggplot(diffs) + 
  aes(x = real, y = nonsense) + 
  stat_smooth(method = "lm") + 
  geom_point() +
  facet_wrap("Study") + 
  geom_abline(slope = 1, intercept = 0) + 
  expand_limits(x = 0)
```



```{r}
scores <- readr::read_csv("./data-raw/test_scores.csv")
tp1 <- scores %>% filter(Study == "TimePoint1")
tp2 <- scores %>% filter(Study == "TimePoint2")
tp3 <- scores %>% filter(Study == "TimePoint3")

diffs %>% 
  inner_join(tp3) %>% 
  ggplot() + 
    aes(x = diff, y = EVT_Standard) + 
    geom_point() +
    stat_smooth(method = "lm")

w_evt <- scores %>% 
  filter(Study != "TimePoint2") %>% 
  select(ResearchID, Study, EVT_Standard) %>% 
  tidyr::spread(Study, EVT_Standard) %>% 
  left_join(diffs)

summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(nonsense), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(diff), w_evt))
summary(lm(scale(TimePoint3) ~ scale(TimePoint1) + scale(real), w_evt))


diffs %>% 
  inner_join(tp3) %>% 
  ggplot() + 
    aes(x = real, y = EVT_Standard) + 
    geom_point() +
    stat_smooth(method = "lm")

diffs %>% 
  inner_join(tp3) %>% 
  select(diff, real, nonsense, EVT_Standard) %>% 
  as.matrix(.) %>% 
  Hmisc::rcorr()
```


```{r}
# library(rstanarm)
# options(mc.cores = parallel::detectCores())

# m_e <- stan_glmer(
#   cbind(Target, Distractor) ~ 
#     (ot1 + ot2 + ot3) * Study * Condition  + 
#     (ot1 + ot2 + ot3 | ResearchID/Condition/Study),
#   family = binomial,
#   prior = normal(0, 2, autoscale = FALSE),
#   prior_intercept = normal(0, 2, autoscale = FALSE),
#   prior_covariance = decov(2, 1, 1),
#   data = d_r_nw_dis)
# readr::write_rds(m_e, "stan_me.rds")
# readr::write_rds(m_e, "stan_me.rds.gz")
```


```{r}
m_e <- readr::read_rds("stan_me.rds.gz")
d <- posterior_linpred(m_e, draws = 1000)
ncol(d)
nrow(d_r_nw_dis)

dlong <- d %>% 
  as.data.frame() %>% 
  tibble::rowid_to_column(".draw") %>% 
  as_tibble() %>% 
  tidyr::gather(".observation", ".estimate", -.draw) %>% 
  mutate(.observation = as.numeric(.observation))

big_big <- d_r_nw_dis %>% 
  tibble::rowid_to_column(".observation") %>% 
  select(.observation:Condition, Time) %>% 
  left_join(dlong) %>% 
  select(-.observation) %>% 
  tidyr::spread(Condition, .estimate)

big_big <- big_big %>% 
  mutate(
    diff_prop = plogis(real) - plogis(nonsense), 
    real = plogis(real), nonsense = plogis(nonsense))

big_big <- big_big %>% 
  tidyr::gather("Condition", "value", nonsense:diff_prop) 

library(ggplot2)
big_big %>% 
  mutate(
    Condition = ifelse(Condition == "diff_prop", "Real - Nonword", Condition),
    Condition = ifelse(Condition == "nonsense", "Nonword", Condition),
    Condition = ifelse(Condition == "real", "Real word", Condition)) %>%
  filter(Study == "TimePoint1") %>% 
  group_by(Study, .draw, Time, Condition) %>% 
  summarise(value = median(value)) %>% 
  ggplot() + 
    aes(x = Time, y = value) + 
    stat_summary(fun.data = median_hilow) + 
    facet_wrap("Condition")

head(d[1, 1:5])
library(bayesplot)
pp_check(test_m, nsample = 200)


```




```{r}

diff_aug <- aug %>% 
  mutate(
    Prop = plogis(elog),
    PropFitted = plogis(.fitted)) %>% 
  select(Study:Condition, Time, Prop, PropFitted, elog, .fitted) %>% 
  tidyr::gather("measure", "value", elog, .fitted, Prop, PropFitted) %>% 
  tidyr::spread(Condition, value) %>% 
  mutate(`real - nonsense` = real - nonsense) %>% 
  tidyr::gather("Condition", "value", nonsense:`real - nonsense`) %>% 
  tidyr::spread(measure, value)

ggplot(diff_aug) + 
  aes(x = Time, y = Prop , color = Condition, linetype = Condition) +
  geom_hline(color = "white", size = 2, yintercept = .5) +
  stat_summary() + 
  stat_summary(aes(y = PropFitted), geom = "line", fun.y = mean) +
  facet_wrap("Study")

diff_aug %>% 
  filter(Condition == "real - nonsense") %>% 
  ggplot() + 
    aes(x = Time, y = Prop) +
    geom_hline(color = "white", size = 2, yintercept = 0) +
    stat_summary(fun.data = median_hilow, size = 1.5,
                 geom = "linerange",
                 fun.args = list(conf.int = .5)) +
    stat_summary(fun.data = median_hilow, 
                 fun.args = list(conf.int = .9)) +
    geom_hline(color = "white", size = .25, yintercept = 0) +
    facet_wrap("Study")


```






```{r explore-rts, eval = FALSE}
da <- readr::read_csv("./data/aim2-screened.csv.gz")

rts <- da %>% 
  filter(
    Bias_Fam %in% c("Familiar", "Unfamiliar"), 
    0 <= Time,
    GazeByImageAOI %in% c("Target", "Distractor")) %>% 
  group_by(
    Study, Condition, ResearchID, TrialNo, TrialID, 
    Bias_ImageAOI, GazeByImageAOI) %>% 
  summarise(FirstLook = min(Time)) %>% 
  ungroup()

rts %>% 
  filter(
    200 <= FirstLook,
    Condition == "real",
    Bias_ImageAOI != GazeByImageAOI,
    Bias_ImageAOI == "Distractor") %>% 
  ggplot() + 
    aes(x = FirstLook) + 
    geom_histogram() +
    facet_wrap(Study ~ Condition)

rts %>% 
  filter(
    200 <= FirstLook,
    Condition == "real",
    Bias_ImageAOI != GazeByImageAOI,
    Bias_ImageAOI == "Distractor") %>% 
  ggplot() + 
    aes(x = Study, y = FirstLook) + 
    geom_point(position = position_jitter(width = .1)) + 
    stat_summary(color = "red") + 
    scale_y_log10()

rts %>% 
  filter(
    200 <= FirstLook,
    Bias_ImageAOI != GazeByImageAOI,
    Bias_ImageAOI == "Distractor",
    Condition != "nonsense") %>% 
  ggplot() + 
    aes(y = interaction(Study, Condition), x = FirstLook) + 
    ggridges::stat_density_ridges()  

rts %>% 
  filter(
    200 <= FirstLook,
    Condition == "real",
    Bias_ImageAOI != GazeByImageAOI,
    Bias_ImageAOI == "Distractor") %>% 
  ggplot() + 
    aes(x = Study, y = FirstLook) + 
    # geom_point(position = position_jitter(width = .1)) + 
    stat_summary(
      aes(group = ResearchID), 
      position = position_jitter(width = .2)) + 
    stat_summary(color = "red") + 
    scale_y_log10()

d_test <- rts %>% 
  filter(
    200 <= FirstLook,
    Condition == "real",
    Bias_ImageAOI != GazeByImageAOI,
    Bias_ImageAOI == "Distractor") %>% 
  mutate(S = factor(Study, c("TimePoint2", "TimePoint1", "TimePoint3")))

library(lme4)
try <- lmer(log(FirstLook) ~ S + (1 | ResearchID/S), d_test)
summary(try)

```

```{r bayes-dead-end, eval = FALSE, include = FALSE}
# library(rstanarm)
# try <- stan_glmer(
#   log(FirstLook) ~ S + (1 | ResearchID/S), 
#   d_test, 
#   family = gaussian(),
#   prior = normal(0, 1),
#   chains = 1, 
#   iter = 1000)
# summary(try)
# 
# pp_check(try)
# pp <- posterior_predict(try)
# t1 <- which(d_test$Study == "TimePoint1")
# t2 <- which(d_test$Study == "TimePoint2")
# t3 <- which(d_test$Study == "TimePoint3")
# 
# bayesplot::ppc_dens_overlay(log(d_test$FirstLook[t1]), yrep = pp[, t1], size = 0.25, alpha = 0.7, trim = FALSE,
#   bw = "nrd0", adjust = 1, kernel = "gaussian", n_dens = 1024)
# 
# bayesplot::ppc_dens_overlay(
#   log(d_test$FirstLook[t1]), 
#   yrep = pp[sample(1:500, size = 50), t1])
# 
# bayesplot::ppc_dens_overlay(
#   d_test$FirstLook[t1], 
#   yrep = exp(pp[sample(1:500, size = 50), t1])) + 
#   ggtitle("FirstLook ~ Study + (1 | ID/Study), Age 3, Real, Unfamiliar Initial") + 
#   labs(caption = "Density of posterior predictions")
# ggsave("misc/bayes-rts-real-age3-unfam.png")
# 
# bayesplot::ppc_dens_overlay(
#   d_test$FirstLook[t2], 
#   yrep = exp(pp[sample(1:500, size = 50), t2])) + 
#   ggtitle("FirstLook ~ Study + (1 | ID/Study), Age 4, Real, Unfamiliar Initial") + 
#   labs(caption = "Density of posterior predictions")
# ggsave("misc/bayes-rts-real-age4-unfam.png")
# 
# 
# bayesplot::ppc_dens_overlay(
#   d_test$FirstLook[t3], 
#   yrep = exp(pp[sample(1:500, size = 50), t3])) + 
#   ggtitle("FirstLook ~ Study + (1 | ID/Study), Age 5, Real, Unfamiliar Initial") + 
#   labs(caption = "Density of posterior predictions")
# ggsave("misc/bayes-rts-real-age5-unfam.png")
# 
```
















```{r}

test_f <- bf(
  elog ~ 
    (ot1 + ot2 + ot3) * Condition + 
    (ot1 + ot2 + ot3 | ResearchID/Condition), 
  family = gaussian)

prior_intercept <- set_prior("normal(0, 1)", class = "Intercept")
prior_b <- set_prior("normal(0, 1)", class = "b")
prior_ot1 <- set_prior("normal(0, 2)", class = "b", coef = "ot1")
prior_cor <- set_prior("lkj(2)", class = "cor")
prior_sd <- set_prior("student_t(3, 0, 1)", class = "sd")
prior_sigma <- set_prior("student_t(3, 0, 1)", class = "sigma")
priors <- c(prior_intercept, prior_b, prior_ot1, prior_cor, prior_sd, prior_sigma)

```






<!-- Observations: -->

<!--   - Probability of looking to familiar image given real word increased in -->
<!--     year 3. Kind of unexpected that they could improve noticeably on this simple -->
<!--     two-image task. -->
<!--   - Probability of looking to unfamiliar given a nonword increases each year. -->
<!--   - Probability of looking to familiar given a mispronunciation increased -->
<!--   - 250 to 1500 looks like a reasonable analysis window. -->
<!--   - Before the onset of the target word, there appears to be some looking -->
<!--     preferences—maybe—for the familiar at timepoint 1 and unfamiliar -->
<!--     in timepoint 3. -->
<!--   - The "peak" growth curve feature will need to be flipped for the nonword -->
<!--     trials. -->
